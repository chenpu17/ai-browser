# 整体架构设计

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        AI Browser                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      API 层                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │  HTTP API   │  │  MCP Server │  │  WebSocket  │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    语义引擎层                              │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │  页面理解器  │  │  元素索引器  │  │  状态追踪器  │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  │  ┌─────────────┐  ┌─────────────┐                        │  │
│  │  │  指令解析器  │  │  操作执行器  │                        │  │
│  │  └─────────────┘  └─────────────┘                        │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    浏览器控制层                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │  CDP 客户端  │  │  会话管理   │  │  事件监听   │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                 Chromium (Headless)                        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 分层职责

### 1. API 层

对外提供服务接口，支持多种协议：

| 协议 | 用途 | 特点 |
|------|------|------|
| HTTP API | 同步请求/响应 | 简单易用，适合单次操作 |
| MCP Server | AI Agent 集成 | 标准化工具协议 |
| WebSocket | 实时通信 | 支持事件推送、长连接 |

### 2. 语义引擎层

核心处理层，负责语义分析和操作执行：

| 模块 | 职责 |
|------|------|
| 页面理解器 | 识别页面类型、提取页面意图、划分区域 |
| 元素索引器 | 构建可交互元素索引、分配语义ID |
| 状态追踪器 | 追踪页面状态、检测变化、判断就绪 |
| 指令解析器 | 解析语义化操作指令 |
| 操作执行器 | 执行操作并返回结果 |

### 3. 浏览器控制层

封装与 Chromium 的交互：

| 模块 | 职责 |
|------|------|
| CDP 客户端 | 通过 Chrome DevTools Protocol 控制浏览器 |
| 会话管理 | 管理浏览器实例、页面、Cookie |
| 事件监听 | 监听 DOM 变化、网络请求、控制台输出 |

### 4. Chromium 层

使用 Headless Chromium 作为渲染引擎，提供：
- 完整的网页渲染能力
- Accessibility Tree
- DOM 快照
- 网络请求拦截

## 横切关注点

### 错误处理

统一的错误处理机制：

```typescript
enum ErrorCode {
  CDP_CONNECTION_FAILED = 'CDP_CONNECTION_FAILED',
  PAGE_LOAD_TIMEOUT = 'PAGE_LOAD_TIMEOUT',
  ELEMENT_NOT_FOUND = 'ELEMENT_NOT_FOUND',
  ACTION_FAILED = 'ACTION_FAILED',
  SESSION_EXPIRED = 'SESSION_EXPIRED'
}

interface BrowserError {
  code: ErrorCode;
  message: string;
  recoverable: boolean;
  context?: Record<string, any>;
}
```
