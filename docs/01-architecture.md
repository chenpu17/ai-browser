# 整体架构设计

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        AI Browser                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     CLI 层                                │  │
│  │  ai-browser ──→ Fastify HTTP + SSE MCP                    │  │
│  │  ai-browser-mcp ──→ stdio MCP                             │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      API 层                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │  HTTP API   │  │  MCP Server │  │  SSE MCP    │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    语义引擎层                              │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │  页面理解器  │  │  元素索引器  │  │  状态追踪器  │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  │  ┌─────────────┐  ┌─────────────┐                        │  │
│  │  │  指令解析器  │  │  操作执行器  │                        │  │
│  │  └─────────────┘  └─────────────┘                        │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    浏览器控制层                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │  CDP 客户端  │  │  会话管理   │  │  事件监听   │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                 Chromium (Headless)                        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 分层职责

### 0. CLI 层

提供两个命令行入口：

| 命令 | 入口文件 | 说明 |
|------|----------|------|
| `ai-browser` | `src/cli/server.ts` | 启动 Fastify HTTP 服务，挂载 REST API、Web UI 和 SSE MCP 端点 |
| `ai-browser-mcp` | `src/cli/mcp-stdio.ts` | 启动 stdio MCP Server，供 Claude Desktop / Cursor 等本地 Agent 调用 |

### 1. API 层

对外提供服务接口，支持多种协议：

| 协议 | 用途 | 特点 |
|------|------|------|
| HTTP REST API | 同步请求/响应 | 简单易用，适合单次操作 |
| MCP Server (stdio) | 本地 AI Agent 集成 | 标准化工具协议，通过 stdin/stdout 通信 |
| MCP Server (SSE) | 远程 AI Agent 集成 | 基于 SSE 的 MCP 传输，支持远程连接 |
| SSE | Agent 事件流 | 实时推送 Agent 执行过程 |

### 2. 语义引擎层

核心处理层，负责语义分析和操作执行：

| 模块 | 职责 |
|------|------|
| 页面理解器 | 识别页面类型、提取页面意图、划分区域 |
| 元素索引器 | 构建可交互元素索引、分配语义ID |
| 状态追踪器 | 追踪页面状态、检测变化、判断就绪 |
| 指令解析器 | 解析语义化操作指令 |
| 操作执行器 | 执行操作并返回结果 |

### 3. 浏览器控制层

封装与 Chromium 的交互：

| 模块 | 职责 |
|------|------|
| CDP 客户端 | 通过 Chrome DevTools Protocol 控制浏览器 |
| 会话管理 | 管理浏览器实例、页面、Cookie |
| 事件监听 | 监听 DOM 变化、网络请求、控制台输出 |

### 4. Chromium 层

使用 Puppeteer 控制 Chromium，支持 headless + headful 双实例：
- 完整的网页渲染能力
- Accessibility Tree
- Headless / Headful 双实例，Cookie 跨实例共享
- 会话与多标签页管理

## 横切关注点

### 错误处理

统一的错误处理机制：

```typescript
enum ErrorCode {
  CDP_CONNECTION_FAILED = 'CDP_CONNECTION_FAILED',
  PAGE_LOAD_TIMEOUT = 'PAGE_LOAD_TIMEOUT',
  ELEMENT_NOT_FOUND = 'ELEMENT_NOT_FOUND',
  ACTION_FAILED = 'ACTION_FAILED',
  SESSION_EXPIRED = 'SESSION_EXPIRED'
}

interface BrowserError {
  code: ErrorCode;
  message: string;
  recoverable: boolean;
  context?: Record<string, any>;
}
```
