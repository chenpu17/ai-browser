<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Browser</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <style>
/* ===== CSS Design System ===== */
:root {
  --bg-canvas: #0d1117;
  --bg-surface: #161b22;
  --bg-overlay: #21262d;
  --border: #30363d;
  --text-primary: #c9d1d9;
  --text-secondary: #8b949e;
  --text-muted: #484f58;
  --accent: #58a6ff;
  --green: #238636;
  --green-hover: #2ea043;
  --red: #da3633;
  --blue: #1f6feb;
  --purple: #8957e5;
  --orange: #f78166;
  --radius-sm: 4px;
  --radius-md: 6px;
  --radius-lg: 8px;
  --radius-xl: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,0.3);
  --transition: 150ms ease;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-canvas);
  color: var(--text-primary);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ===== Header / Nav ===== */
.app-header {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  display: flex;
  align-items: center;
  height: 48px;
  flex-shrink: 0;
  gap: 16px;
}
.app-logo {
  color: var(--accent);
  font-size: 15px;
  font-weight: 700;
  white-space: nowrap;
  letter-spacing: -0.3px;
}
.nav-tabs {
  display: flex;
  gap: 2px;
  margin-left: 8px;
}
.nav-tab {
  padding: 6px 16px;
  font-size: 13px;
  font-weight: 500;
  border: none;
  border-radius: var(--radius-md);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
}
.nav-tab:hover { color: var(--text-primary); background: var(--bg-overlay); }
.nav-tab.active {
  color: var(--accent);
  background: rgba(88,166,255,0.1);
}
.nav-tab.active::after {
  content: '';
  position: absolute;
  bottom: -7px;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 2px;
  background: var(--accent);
  border-radius: 1px;
}
.header-right {
  display: flex;
  gap: 8px;
  margin-left: auto;
}

/* ===== Shared Button Styles ===== */
.btn {
  padding: 6px 14px;
  font-size: 13px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 500;
  transition: all var(--transition);
  background: var(--bg-overlay);
  color: var(--text-primary);
  white-space: nowrap;
}
.btn:hover { border-color: var(--accent); color: var(--accent); }
.btn-primary {
  background: var(--green);
  color: #fff;
  border-color: var(--green);
}
.btn-primary:hover { background: var(--green-hover); border-color: var(--green-hover); color: #fff; }
.btn-primary:disabled {
  background: var(--bg-overlay);
  color: var(--text-muted);
  border-color: var(--border);
  cursor: not-allowed;
}
.btn-danger { border-color: var(--red); color: var(--red); }
.btn-danger:hover { background: var(--red); color: #fff; }
.btn-send {
  padding: 10px 20px;
  background: var(--green);
  color: #fff;
  border: none;
  border-radius: var(--radius-lg);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}
.btn-send:hover { background: var(--green-hover); }
.btn-send:disabled { background: var(--bg-overlay); color: var(--text-muted); cursor: not-allowed; }

/* ===== Main Layout ===== */
.app-main {
  flex: 1;
  overflow: hidden;
  position: relative;
}
.view {
  display: none;
  position: absolute;
  inset: 0;
  flex-direction: column;
}
.view.active {
  display: flex;
  animation: viewFadeIn 200ms ease;
}
@keyframes viewFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ===== Shared Modal ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
.modal-overlay.hidden { display: none; }
.modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 24px;
  width: 440px;
  max-width: 90vw;
}
.modal h2 { font-size: 16px; color: var(--text-primary); margin-bottom: 16px; }
.modal label {
  display: block;
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 4px;
  margin-top: 12px;
}
.modal label:first-of-type { margin-top: 0; }
.modal input[type="text"],
.modal input[type="password"],
.modal input[type="number"] {
  width: 100%;
  padding: 8px 12px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
}
.modal input:focus { border-color: var(--accent); }
.modal-btns {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}
.btn-save { background: var(--green); color: #fff; border-color: var(--green); }
.btn-save:hover { background: var(--green-hover); color: #fff; }

/* ===== Shared Markdown ===== */
.markdown-body {
  background: transparent !important;
  color: var(--text-primary) !important;
}
.markdown-body pre { background: var(--bg-surface) !important; }
.markdown-body code { background: var(--bg-overlay) !important; }
.markdown-body table { font-size: 13px; }
</style>
<style>
/* ===== Semantic View Styles ===== */
#view-semantic .sem-toolbar {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-shrink: 0;
}
#view-semantic .sem-toolbar input[type="text"] {
  flex: 1;
  padding: 8px 14px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
}
#view-semantic .sem-toolbar input:focus { border-color: var(--accent); }

.sem-stats-bar {
  background: var(--bg-overlay);
  border-bottom: 1px solid var(--border);
  padding: 6px 20px;
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: var(--text-secondary);
  flex-shrink: 0;
}
.sem-stats-bar .stat-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.sem-stats-bar .stat-val {
  color: var(--accent);
  font-weight: 600;
}
.sem-stats-bar.hidden { display: none; }

.sem-body {
  flex: 1;
  display: flex;
  overflow: hidden;
  padding-bottom: 28px;
}
.sem-left {
  width: 60%;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  overflow: hidden;
}
.sem-right {
  width: 40%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sem-content-tabs {
  display: flex;
  gap: 2px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
}
.sem-content-tab {
  padding: 4px 12px;
  font-size: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
}
.sem-content-tab.active { background: var(--bg-overlay); color: var(--accent); border-color: var(--accent); }

.sem-content-area {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.sem-right-tabs {
  display: flex;
  gap: 2px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
}

.sem-right-area {
  flex: 1;
  overflow: auto;
}
.sem-right-area.screenshot-mode {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #010409;
  padding: 12px;
}
.sem-right-area img {
  max-width: 100%;
  max-height: 100%;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}
.sem-right-area .raw-output {
  padding: 16px;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 13px;
  white-space: pre-wrap;
  word-break: break-all;
  color: var(--text-secondary);
}

/* Element list */
.element-list { padding: 0; }
.element-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 6px;
  background: var(--bg-canvas);
  transition: all 0.15s;
}
.element-item:hover { border-color: var(--accent); background: var(--bg-surface); }
.element-info { flex: 1; min-width: 0; }
.element-type {
  display: inline-block;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
  margin-right: 8px;
}
.element-type.button { background: var(--green); color: white; }
.element-type.link { background: var(--blue); color: white; }
.element-type.textbox { background: var(--purple); color: white; }
.element-type.checkbox { background: var(--orange); color: white; }
.element-label { font-weight: 500; color: var(--text-primary); font-size: 13px; }
.element-id {
  font-size: 11px;
  color: #6e7681;
  font-family: monospace;
  margin-top: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
}
.element-actions { display: flex; gap: 4px; }
.btn-action {
  padding: 4px 10px;
  font-size: 12px;
  background: var(--bg-overlay);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition);
}
.btn-action:hover { background: var(--border); }
.btn-action.btn-click { border-color: var(--green); }
.btn-action.btn-click:hover { background: var(--green); color: #fff; }
.btn-action.btn-type { border-color: var(--purple); }
.btn-action.btn-type:hover { background: var(--purple); color: #fff; }

.filter-bar {
  display: flex;
  gap: 6px;
  padding: 8px 16px;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
}
.filter-bar.hidden { display: none; }
.filter-btn {
  padding: 3px 10px;
  font-size: 11px;
  background: var(--bg-overlay);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
}
.filter-btn.active { background: var(--blue); color: white; border-color: var(--blue); }

/* Log drawer */
.sem-log-drawer {
  border-top: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
  max-height: 0;
  overflow: hidden;
  transition: max-height 200ms ease;
}
.sem-log-drawer.open { max-height: 180px; }
.sem-log-toggle {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 28px;
  background: var(--bg-overlay);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 11px;
  color: var(--text-secondary);
  z-index: 2;
}
.sem-log-toggle:hover { color: var(--text-primary); }
.sem-log-entries {
  padding: 8px 16px;
  overflow-y: auto;
  max-height: 150px;
  font-family: monospace;
  font-size: 12px;
}
.log-entry { padding: 3px 0; border-bottom: 1px solid var(--bg-overlay); }
.log-entry:last-child { border-bottom: none; }
.log-time { color: #6e7681; }
.log-success { color: #3fb950; }
.log-error { color: #f85149; }
.log-info { color: var(--accent); }

.sem-status {
  padding: 6px 20px;
  font-size: 12px;
  flex-shrink: 0;
  display: none;
}
.sem-status.visible { display: block; }
.sem-status.loading { background: #1f2937; color: #60a5fa; }
.sem-status.success { background: #064e3b; color: #34d399; }
.sem-status.error { background: #7f1d1d; color: #fca5a5; }

.placeholder-text {
  color: var(--text-muted);
  font-size: 14px;
  text-align: center;
  padding: 40px 20px;
}
</style>
<style>
/* ===== Agent View Styles ===== */
#view-agent .agent-main { display: flex; flex: 1; overflow: hidden; }

.chat-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.chat-input-bar {
  border-top: 1px solid var(--border);
  padding: 12px 16px;
  display: flex;
  gap: 8px;
  background: var(--bg-surface);
}
.chat-input-bar input {
  flex: 1;
  padding: 10px 14px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
}
.chat-input-bar input:focus { border-color: var(--accent); }

/* Preview panel */
.preview-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
}
.preview-header {
  background: var(--bg-surface);
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.preview-tabs { display: flex; gap: 4px; }
.preview-tab {
  padding: 4px 14px;
  font-size: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
}
.preview-tab.active { background: var(--bg-overlay); color: var(--accent); border-color: var(--accent); }
.preview-url {
  font-size: 12px;
  color: var(--accent);
  margin-left: auto;
  max-width: 50%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.preview-body {
  flex: 1;
  overflow: auto;
  background: var(--bg-canvas);
}
.preview-body.screenshot-mode {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #010409;
  padding: 12px;
  position: relative;
}
.screenshot-loading::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 1;
}
.screenshot-loading::after {
  content: '';
  position: absolute;
  width: 24px; height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  z-index: 2;
}
@keyframes spin { to { transform: rotate(360deg); } }
.screenshot-updated { box-shadow: inset 0 0 0 2px var(--accent); transition: box-shadow 0.3s ease; }
.preview-body img {
  max-width: 100%;
  max-height: 100%;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

/* Markdown preview areas */
.md-current { padding: 16px; }
.md-history {
  border-top: 1px solid var(--border);
  padding: 8px 16px;
}
.md-history-item {
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 6px;
  overflow: hidden;
}
.md-history-toggle {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-surface);
  border: none;
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 6px;
}
.md-history-toggle:hover { color: var(--text-primary); }
.md-history-toggle .arrow { transition: transform 0.2s; }
.md-history-toggle.open .arrow { transform: rotate(90deg); }
.md-history-content {
  display: none;
  padding: 12px;
  max-height: 300px;
  overflow: auto;
}
.md-history-content.open { display: block; }
.md-history-content .markdown-body { font-size: 13px; }

/* Chat message styles */
.msg { margin-bottom: 10px; }
.msg-user { text-align: right; }
.msg-user .bubble {
  display: inline-block;
  background: var(--blue);
  color: #fff;
  padding: 8px 14px;
  border-radius: 12px 12px 2px 12px;
  max-width: 85%;
  text-align: left;
  font-size: 14px;
  animation: fadeIn 200ms ease;
}
.msg-system {
  text-align: center;
  color: var(--text-muted);
  font-size: 12px;
  padding: 4px 0;
}
.msg-thinking {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 8px 12px;
  font-size: 13px;
  color: var(--text-secondary);
  font-style: italic;
  animation: fadeIn 200ms ease;
}
.msg-thinking .markdown-body { font-style: normal; font-size: 13px; }
.msg .md-inline { font-style: normal; }
.msg-tool-call {
  background: var(--bg-canvas);
  border: 1px solid var(--blue);
  border-radius: var(--radius-lg);
  padding: 8px 12px;
  font-size: 13px;
  animation: fadeIn 200ms ease;
}
.msg-tool-call .tool-header {
  display: flex;
  align-items: center;
  gap: 6px;
}
.msg-tool-call .tool-icon {
  font-size: 12px;
  color: var(--accent);
}
.msg-tool-call .label { color: var(--accent); font-weight: 600; }
.msg-tool-call .tool-desc { color: var(--text-primary); font-size: 13px; }
.msg-tool-call details.tool-raw {
  margin-top: 4px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.msg-tool-call details.tool-raw summary {
  padding: 3px 8px;
  font-size: 11px;
  color: var(--text-muted);
  cursor: pointer;
  background: var(--bg-surface);
}
.msg-tool-call details.tool-raw summary:hover { color: var(--text-secondary); }
.msg-tool-call details.tool-raw pre {
  margin: 0;
  padding: 6px 8px;
  font-size: 11px;
}
.msg-tool-call pre {
  margin: 4px 0 0;
  color: var(--text-primary);
  font-size: 12px;
  white-space: pre-wrap;
  word-break: break-all;
}

/* Collapsible tool result */
.msg-tool-result {
  background: var(--bg-canvas);
  border-radius: var(--radius-lg);
  padding: 8px 12px;
  font-size: 13px;
  animation: fadeIn 200ms ease;
}
.msg-tool-result.success { border: 1px solid var(--green); }
.msg-tool-result.fail { border: 1px solid var(--red); }
.msg-tool-result .result-content {
  max-height: 120px;
  overflow: hidden;
  position: relative;
  transition: max-height 200ms ease;
}
.msg-tool-result .result-content.expanded { max-height: none; }
.msg-tool-result .result-content.needs-expand::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 30px;
  background: linear-gradient(transparent, var(--bg-canvas));
  pointer-events: none;
}
.msg-tool-result .result-content.expanded::after { display: none; }
.msg-tool-result .expand-btn {
  display: none;
  margin-top: 4px;
  font-size: 11px;
  color: var(--accent);
  cursor: pointer;
  background: none;
  border: none;
  padding: 2px 0;
}
.msg-tool-result .expand-btn.visible { display: inline-block; }
.msg-tool-result pre {
  margin: 4px 0 0;
  color: var(--text-secondary);
  font-size: 12px;
  white-space: pre-wrap;
  word-break: break-all;
}

.msg-error {
  background: #1c0c0c;
  border: 1px solid var(--red);
  border-radius: var(--radius-lg);
  padding: 8px 12px;
  font-size: 13px;
  color: #fca5a5;
  animation: fadeIn 200ms ease;
}
.msg-done {
  border-radius: 10px;
  padding: 12px 16px;
  font-size: 14px;
  animation: fadeIn 200ms ease;
}
.msg-done.success { background: #0a2e1a; border: 2px solid var(--green); }
.msg-done.fail { background: #2d0a0a; border: 2px solid var(--red); }
.msg-done .title { font-weight: 700; margin-bottom: 4px; }
.msg-done .markdown-body { font-size: 14px; }

.step-tag {
  display: inline-block;
  background: var(--bg-overlay);
  color: var(--text-secondary);
  font-size: 11px;
  padding: 1px 6px;
  border-radius: 3px;
  margin-right: 6px;
  font-style: normal;
}

/* Progress bar */
.progress-bar-wrap {
  height: 3px;
  background: var(--bg-overlay);
  border-radius: 2px;
  overflow: hidden;
  margin: 0;
  display: none;
}
.progress-bar-wrap.active { display: block; }
.progress-bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width 0.4s ease;
  width: 0%;
}
.progress-info {
  display: none;
  font-size: 11px;
  color: var(--text-muted);
  padding: 4px 16px;
  gap: 12px;
  background: var(--bg-surface);
}
.progress-info.active { display: flex; align-items: center; }
.progress-phase { text-transform: capitalize; color: var(--text-secondary); }
.progress-percent { color: var(--accent); font-weight: 600; }

/* Typing indicator */
.typing-indicator {
  display: none;
  padding: 8px 0;
}
.typing-indicator.visible { display: flex; gap: 4px; align-items: center; padding-left: 4px; }
.typing-dot {
  width: 6px;
  height: 6px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typingBounce 1.2s infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-4px); opacity: 1; }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Type input modal (semantic view) */
.type-input-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.type-input-modal.hidden { display: none; }
.type-input-modal .modal-content {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  width: 400px;
}
.type-input-modal .modal-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
}
.type-input-modal .modal-input {
  width: 100%;
  padding: 10px 14px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
  margin-bottom: 16px;
}
.type-input-modal .modal-input:focus { border-color: var(--accent); }
.type-input-modal .modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* ===== Tasks View Styles ===== */
.tasks-toolbar {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-shrink: 0;
}
.tasks-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 12px;
  align-content: start;
}
.task-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px;
  cursor: pointer;
  transition: all var(--transition);
}
.task-card:hover { border-color: var(--accent); }
.task-card .task-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.task-card .task-id {
  font-size: 11px;
  color: var(--text-muted);
  font-family: monospace;
}
.task-status {
  display: inline-block;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
}
.task-status.running { background: rgba(88,166,255,0.15); color: var(--accent); }
.task-status.done { background: rgba(35,134,54,0.15); color: #3fb950; }
.task-status.failed { background: rgba(218,54,51,0.15); color: #f85149; }
.task-status.pending { background: var(--bg-overlay); color: var(--text-muted); }
.task-card .task-goal {
  font-size: 14px;
  color: var(--text-primary);
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.task-card .task-meta {
  font-size: 12px;
  color: var(--text-muted);
}
.task-detail {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.task-detail-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.task-detail-back {
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  font-size: 14px;
  padding: 4px 8px;
}
.task-detail-back:hover { text-decoration: underline; }
.task-detail .meta-grid {
  display: grid;
  grid-template-columns: 120px 1fr;
  row-gap: 8px;
  font-size: 14px;
  margin-bottom: 16px;
}
.task-detail .meta-key { color: var(--text-muted); }
.task-detail pre {
  background: var(--bg-canvas);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 12px;
  overflow: auto;
  max-height: 400px;
  font-size: 13px;
  white-space: pre-wrap;
  word-break: break-all;
}
.task-create-form {
  max-width: 600px;
}
.task-create-form label {
  display: block;
  font-size: 13px;
  color: var(--text-secondary);
  margin: 12px 0 4px;
}
.task-create-form input,
.task-create-form textarea {
  width: 100%;
  padding: 8px 12px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
}
.task-create-form input:focus,
.task-create-form textarea:focus { border-color: var(--accent); }
.task-create-form textarea { min-height: 80px; resize: vertical; }
.task-create-form .form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.task-create-form .form-actions {
  margin-top: 16px;
  display: flex;
  gap: 8px;
}

/* ===== Responsive ===== */
@media (max-width: 900px) {
  .sem-body { flex-direction: column; padding-bottom: 28px; }
  .sem-left, .sem-right { width: 100%; border-right: none; }
  .sem-right { border-top: 1px solid var(--border); }
  #view-agent .agent-main { flex-direction: column; }
  .chat-panel, .preview-panel { width: 100%; border-right: none; }
  .preview-panel { border-top: 1px solid var(--border); }
  .tasks-list { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
  .app-logo { font-size: 13px; }
  .nav-tab { padding: 5px 10px; font-size: 12px; }
  .preview-panel { max-height: 40vh; }
  .progress-info { padding: 3px 12px; font-size: 10px; }
  .modal { width: 95vw; padding: 16px; }
  .task-create-form .form-row { grid-template-columns: 1fr; }
}
@media (max-width: 480px) {
  .preview-panel { display: none; }
  .chat-panel { width: 100%; border-right: none; }
  .chat-input-bar input { font-size: 16px; padding: 12px 14px; }
  .msg-tool-result .result-content { max-height: 80px; }
  .header-right { gap: 4px; }
  .btn { padding: 5px 8px; font-size: 12px; }
}
  </style>
</head>
<body>
<!-- ===== Header ===== -->
<header class="app-header">
  <span class="app-logo">AI Browser</span>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchView('semantic')">Semantic</button>
    <button class="nav-tab" onclick="switchView('agent')">Agent</button>
    <button class="nav-tab" onclick="switchView('tasks')">Tasks</button>
  </div>
  <div class="header-right" id="headerRight">
    <button class="btn" id="btnCloseSession" style="display:none" onclick="Sem.closeSession()">Close Session</button>
    <button class="btn btn-danger" id="btnStop" style="display:none" onclick="Agent.stop()">Stop</button>
    <button class="btn" id="btnClear" style="display:none" onclick="Agent.clearChat()">Clear</button>
    <button class="btn" id="btnSettings" onclick="openSettings()">Settings</button>
  </div>
</header>

<!-- ===== Main ===== -->
<main class="app-main">
  <!-- Semantic View -->
  <div id="view-semantic" class="view active">
    <!-- Toolbar -->
    <div class="sem-toolbar">
      <input type="text" id="semUrlInput" placeholder="Enter URL, e.g. https://www.baidu.com" value="https://www.baidu.com">
      <button class="btn btn-primary" id="semAnalyzeBtn" onclick="Sem.analyze()">Analyze</button>
      <button class="btn" id="semRefreshBtn" style="display:none" onclick="Sem.refreshElements()">Refresh</button>
      <button class="btn" id="semSendToAgent" style="display:none" onclick="sendToAgent()">Send to Agent</button>
    </div>

    <!-- Status bar -->
    <div class="sem-status" id="semStatus"></div>

    <!-- Current page info -->
    <div class="sem-stats-bar hidden" id="semCurrentPage" style="gap:8px;">
      <span style="color:var(--text-secondary)">Current:</span>
      <a id="semCurrentUrl" href="#" target="_blank" style="color:var(--accent);text-decoration:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%;"></a>
      <span id="semCurrentTitle" style="color:var(--text-secondary);"></span>
    </div>

    <!-- Stats bar -->
    <div class="sem-stats-bar hidden" id="semStatsBar"></div>

    <!-- Body: left + right columns -->
    <div class="sem-body">
      <!-- Left column (60%) -->
      <div class="sem-left">
        <div class="sem-content-tabs">
          <button class="sem-content-tab active" onclick="Sem.switchLeftTab('markdown', this)">Markdown</button>
          <button class="sem-content-tab" onclick="Sem.switchLeftTab('elements', this)">Elements</button>
        </div>
        <div class="filter-bar hidden" id="semFilterBar"></div>
        <div class="sem-content-area" id="semLeftContent">
          <div class="placeholder-text">Enter a URL and click Analyze to start</div>
        </div>
      </div>

      <!-- Right column (40%) -->
      <div class="sem-right">
        <div class="sem-right-tabs" id="semRightTabs">
          <button class="sem-content-tab active" onclick="Sem.switchRightTab('screenshot', this)">Screenshot</button>
          <button class="sem-content-tab" onclick="Sem.switchRightTab('raw', this)">Raw Markdown</button>
        </div>
        <div class="sem-right-area" id="semRightContent">
          <div class="placeholder-text">Waiting for analysis...</div>
        </div>
      </div>
    </div>

    <!-- Log drawer toggle -->
    <div class="sem-log-toggle" onclick="Sem.toggleLog()">
      <span id="semLogToggleText">Show Log (0)</span>
    </div>
    <div class="sem-log-drawer" id="semLogDrawer">
      <div class="sem-log-entries" id="semLogEntries"></div>
    </div>
  </div>

  <!-- Agent View -->
  <div id="view-agent" class="view">
    <div class="agent-main">
      <!-- Left: Chat -->
      <div class="chat-panel">
        <div class="chat-messages" id="chatMessages">
          <div class="placeholder-text">Enter a task to start</div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <div class="progress-bar-wrap" id="progressBar">
          <div class="progress-bar-fill" id="progressFill"></div>
        </div>
        <div class="progress-info" id="progressInfo">
          <span class="progress-phase" id="progressPhase"></span>
          <span class="progress-percent" id="progressPercent"></span>
          <span id="progressSteps"></span>
        </div>
        <div class="chat-input-bar">
          <input type="text" id="taskInput" placeholder="Enter a task, e.g.: Open Baidu and search for weather">
          <button class="btn-send" id="sendBtn" onclick="Agent.start()">Send</button>
        </div>
      </div>

      <!-- Right: Preview -->
      <div class="preview-panel">
        <div class="preview-header">
          <div class="preview-tabs">
            <button class="preview-tab active" id="agentTabMd" onclick="Agent.switchPreview('markdown')">Markdown</button>
            <button class="preview-tab" id="agentTabSs" onclick="Agent.switchPreview('screenshot')">Screenshot</button>
          </div>
          <button class="btn" id="agentViewElements" style="display:none" onclick="viewElementsFromAgent()">View Elements</button>
          <span class="preview-url" id="previewUrl"></span>
        </div>
        <div class="preview-body" id="previewBody">
          <div class="placeholder-text">Waiting for Agent output...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks View -->
  <div id="view-tasks" class="view">
    <div class="tasks-toolbar">
      <button class="btn btn-primary" id="btnNewTask" onclick="Tasks.showCreate()">+ New Task</button>
      <button class="btn" onclick="Tasks.refreshList()">Refresh</button>
    </div>
    <div id="tasksList" class="tasks-list">
      <div class="placeholder-text">Loading tasks...</div>
    </div>
    <div id="taskDetail" class="task-detail" style="display:none"></div>
    <div id="taskCreate" class="task-detail" style="display:none"></div>
  </div>
</main>
<div class="modal-overlay hidden" id="settingsModal">
  <div class="modal">
    <h2>Model Settings</h2>
    <label>Base URL</label>
    <input type="text" id="cfgBaseURL" placeholder="https://api.openai.com/v1">
    <label>Model</label>
    <input type="text" id="cfgModel" placeholder="gpt-4">
    <label>API Key</label>
    <input type="password" id="cfgApiKey" placeholder="sk-...">
    <label>Max Iterations</label>
    <input type="number" id="cfgMaxIterations" placeholder="Default (server-controlled)" min="1" max="1000">
    <label style="display:flex;align-items:center;gap:8px;margin-top:14px;cursor:pointer;">
      <input type="checkbox" id="cfgHeadless" checked style="width:auto;cursor:pointer;">
      Headless Mode
      <span style="color:var(--text-muted);font-size:12px;">(Turn off to see browser window for manual login)</span>
    </label>
    <div class="modal-btns">
      <button class="btn" onclick="closeSettings()">Cancel</button>
      <button class="btn" id="btnTestConn" onclick="testConnection()">Test Connection</button>
      <button class="btn btn-save" onclick="saveSettings()">Save</button>
    </div>
    <div id="connTestResult" style="margin-top:8px;font-size:12px;display:none;"></div>
  </div>
</div>

<!-- ===== Type Input Modal (semantic view) ===== -->
<div id="typeModal" class="type-input-modal hidden">
  <div class="modal-content">
    <div class="modal-title">Type Text</div>
    <input type="text" id="typeValue" class="modal-input" placeholder="Enter text to type">
    <div class="modal-buttons">
      <button class="btn" onclick="Sem.closeTypeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="Sem.confirmType()">Confirm</button>
    </div>
  </div>
</div>

<script>
// ========== Shared State ==========
var App = {
  currentView: 'semantic',
  sharedSessionId: null,
};

// ========== Shared Utilities ==========
function esc(s) {
  var d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function safeMd(s) {
  return DOMPurify.sanitize(marked.parse(s || ''));
}

// ========== Settings (localStorage, shared) ==========
var SETTINGS_KEY = 'ai_browser_agent_settings';

function loadSettings() {
  try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }
  catch(e) { return {}; }
}

function openSettings() {
  var s = loadSettings();
  document.getElementById('cfgBaseURL').value = s.baseURL || '';
  document.getElementById('cfgModel').value = s.model || '';
  document.getElementById('cfgApiKey').value = s.apiKey || '';
  document.getElementById('cfgMaxIterations').value = s.maxIterations || '';
  document.getElementById('cfgHeadless').checked = s.headless !== false;
  document.getElementById('settingsModal').classList.remove('hidden');
}

function closeSettings() {
  document.getElementById('settingsModal').classList.add('hidden');
}

function saveSettings() {
  var settings = {
    baseURL: document.getElementById('cfgBaseURL').value.trim(),
    model: document.getElementById('cfgModel').value.trim(),
    apiKey: document.getElementById('cfgApiKey').value.trim(),
    maxIterations: parseInt(document.getElementById('cfgMaxIterations').value) || 0,
    headless: document.getElementById('cfgHeadless').checked,
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  closeSettings();
}

function testConnection() {
  var btn = document.getElementById('btnTestConn');
  var result = document.getElementById('connTestResult');
  btn.disabled = true;
  btn.textContent = 'Testing...';
  result.style.display = 'block';
  result.style.color = 'var(--text-muted)';
  result.textContent = 'Connecting...';

  var body = {
    baseURL: document.getElementById('cfgBaseURL').value.trim(),
    model: document.getElementById('cfgModel').value.trim(),
    apiKey: document.getElementById('cfgApiKey').value.trim(),
  };

  fetch('/v1/llm/test', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  }).then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.ok) {
      result.style.color = '#3fb950';
      result.textContent = '\u2713 Connected â€” ' + (data.model || 'OK') + ' (' + (data.latencyMs || '?') + 'ms)';
    } else {
      result.style.color = '#f85149';
      result.textContent = '\u2717 Failed: ' + (data.error || 'Unknown error');
    }
  }).catch(function(err) {
    result.style.color = '#f85149';
    result.textContent = '\u2717 ' + err.message;
  }).finally(function() {
    btn.disabled = false;
    btn.textContent = 'Test Connection';
  });
}

// ========== Navigation ==========
function switchView(view) {
  App.currentView = view;
  location.hash = view;
  // Clean up Tasks polling when leaving
  if (view !== 'tasks' && Tasks.pollTimer) {
    clearInterval(Tasks.pollTimer);
    Tasks.pollTimer = null;
  }
  document.getElementById('view-semantic').classList.toggle('active', view === 'semantic');
  document.getElementById('view-agent').classList.toggle('active', view === 'agent');
  document.getElementById('view-tasks').classList.toggle('active', view === 'tasks');
  // Update nav tabs
  document.querySelectorAll('.nav-tab').forEach(function(tab) {
    tab.classList.toggle('active', tab.textContent.toLowerCase() === view);
  });
  if (view === 'tasks') Tasks.refreshList();
  updateHeaderButtons();
}

function updateHeaderButtons() {
  var view = App.currentView;
  // Semantic buttons
  document.getElementById('btnCloseSession').style.display =
    (view === 'semantic' && Sem.sessionId) ? 'inline-block' : 'none';
  // Agent buttons
  document.getElementById('btnStop').style.display =
    (view === 'agent' && Agent.agentId) ? 'inline-block' : 'none';
  document.getElementById('btnClear').style.display =
    (view === 'agent') ? 'inline-block' : 'none';
  // Settings always visible
}

// Hash routing
window.addEventListener('hashchange', function() {
  var hash = location.hash.replace('#', '');
  var view = (hash === 'agent') ? 'agent' : (hash === 'tasks') ? 'tasks' : 'semantic';
  if (view !== App.currentView) switchView(view);
});

// Session sharing: Semantic -> Agent
function sendToAgent() {
  if (Sem.sessionId) {
    App.sharedSessionId = Sem.sessionId;
  }
  switchView('agent');
}

// Session sharing: Agent -> Semantic (view elements)
function viewElementsFromAgent() {
  if (Agent.sessionId) {
    App.sharedSessionId = Agent.sessionId;
  }
  switchView('semantic');
}

// Close modal on overlay click
document.getElementById('settingsModal').addEventListener('click', function(e) {
  if (e.target === this) closeSettings();
});
</script>

<script>
// ========== Semantic View ==========
var Sem = {
  sessionId: null,
  currentElements: [],
  currentFilter: 'all',
  pendingTypeElementId: null,
  leftTab: 'markdown',
  rightTab: 'screenshot',
  rawMarkdown: '',
  screenshotHtml: '',
  logCount: 0,

  showStatus: function(msg, type) {
    var el = document.getElementById('semStatus');
    el.className = 'sem-status visible ' + type;
    el.textContent = msg;
  },

  hideStatus: function() {
    document.getElementById('semStatus').className = 'sem-status';
  },

  addLog: function(message, type) {
    type = type || 'info';
    this.logCount++;
    var entries = document.getElementById('semLogEntries');
    var time = new Date().toLocaleTimeString();
    entries.innerHTML = '<div class="log-entry"><span class="log-time">[' + time + ']</span> <span class="log-' + esc(type) + '">' + esc(message) + '</span></div>' + entries.innerHTML;
    document.getElementById('semLogToggleText').textContent = 'Show Log (' + this.logCount + ')';
  },

  toggleLog: function() {
    var drawer = document.getElementById('semLogDrawer');
    drawer.classList.toggle('open');
    var isOpen = drawer.classList.contains('open');
    document.getElementById('semLogToggleText').textContent =
      (isOpen ? 'Hide' : 'Show') + ' Log (' + this.logCount + ')';
  },

  switchLeftTab: function(tab, btn) {
    this.leftTab = tab;
    btn.parentElement.querySelectorAll('.sem-content-tab').forEach(function(t) { t.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('semFilterBar').classList.toggle('hidden', tab !== 'elements');
    this.renderLeftContent();
  },

  switchRightTab: function(tab, btn) {
    this.rightTab = tab;
    btn.parentElement.querySelectorAll('.sem-content-tab').forEach(function(t) { t.classList.remove('active'); });
    btn.classList.add('active');
    this.renderRightContent();
  },

  renderLeftContent: function() {
    var area = document.getElementById('semLeftContent');
    if (this.leftTab === 'markdown') {
      if (!this.rawMarkdown) {
        area.innerHTML = '<div class="placeholder-text">Enter a URL and click Analyze to start</div>';
      } else {
        area.innerHTML = '<div class="markdown-body">' + safeMd(this.rawMarkdown) + '</div>';
      }
    } else {
      this.renderElements(area);
    }
  },

  renderRightContent: function() {
    var area = document.getElementById('semRightContent');
    if (this.rightTab === 'screenshot') {
      if (this.screenshotHtml) {
        area.className = 'sem-right-area screenshot-mode';
        area.innerHTML = this.screenshotHtml;
      } else {
        area.className = 'sem-right-area';
        area.innerHTML = '<div class="placeholder-text">Waiting for screenshot...</div>';
      }
    } else {
      area.className = 'sem-right-area';
      if (this.rawMarkdown) {
        area.innerHTML = '<div class="raw-output">' + esc(this.rawMarkdown) + '</div>';
      } else {
        area.innerHTML = '<div class="placeholder-text">Waiting for analysis...</div>';
      }
    }
  },

  renderElements: function(container) {
    var elements = this.currentElements;
    var filtered = this.currentFilter === 'all' ? elements : elements.filter(function(e) { return e.type === Sem.currentFilter; });
    if (!container) container = document.getElementById('semLeftContent');

    if (filtered.length === 0) {
      container.innerHTML = '<div class="placeholder-text">No elements found</div>';
      return;
    }

    container.innerHTML = '<div class="element-list">' + filtered.map(function(el) {
      var label = el.label || '(no label)';
      var actions = el.actions || ['click'];
      var safeId = esc(el.id).replace(/'/g, '&#39;');
      var actionBtns = actions.map(function(a) {
        if (a === 'click') return '<button class="btn-action btn-click" data-sem-action="click" data-sem-id="' + safeId + '">Click</button>';
        if (a === 'type') return '<button class="btn-action btn-type" data-sem-action="type" data-sem-id="' + safeId + '">Type</button>';
        return '';
      }).join('');

      return '<div class="element-item">' +
        '<div class="element-info">' +
        '<span class="element-type ' + el.type + '">' + el.type + '</span>' +
        '<span class="element-label">' + esc(label) + '</span>' +
        '<div class="element-id">' + esc(el.id) + '</div>' +
        '</div>' +
        '<div class="element-actions">' + actionBtns + '</div>' +
        '</div>';
    }).join('') + '</div>';
  },

  renderFilterBar: function() {
    var elements = this.currentElements;
    var types = [];
    var seen = {};
    elements.forEach(function(e) { if (!seen[e.type]) { seen[e.type] = true; types.push(e.type); } });
    var bar = document.getElementById('semFilterBar');
    bar.classList.remove('hidden');
    bar.innerHTML = '<button class="filter-btn ' + (this.currentFilter === 'all' ? 'active' : '') + '" data-filter="all">All (' + elements.length + ')</button>' +
      types.map(function(t) {
        var count = elements.filter(function(e) { return e.type === t; }).length;
        return '<button class="filter-btn ' + (Sem.currentFilter === t ? 'active' : '') + '" data-filter="' + esc(t) + '">' + esc(t) + ' (' + count + ')</button>';
      }).join('');
  },

  setFilter: function(type) {
    this.currentFilter = type;
    this.renderFilterBar();
    if (this.leftTab === 'elements') this.renderLeftContent();
  },

  showStats: function(semData) {
    var elements = semData.elements || [];
    var typeCount = {};
    elements.forEach(function(el) { typeCount[el.type] = (typeCount[el.type] || 0) + 1; });

    var bar = document.getElementById('semStatsBar');
    bar.classList.remove('hidden');
    bar.innerHTML =
      '<div class="stat-item"><span class="stat-val">' + elements.length + '</span> elements</div>' +
      '<div class="stat-item"><span class="stat-val">' + (typeCount.button || 0) + '</span> buttons</div>' +
      '<div class="stat-item"><span class="stat-val">' + (typeCount.link || 0) + '</span> links</div>' +
      '<div class="stat-item"><span class="stat-val">' + (typeCount.textbox || 0) + '</span> inputs</div>' +
      '<div class="stat-item"><span class="stat-val">' + (semData.regions || []).length + '</span> regions</div>';
  },

  updateCurrentPage: function(url, title) {
    var container = document.getElementById('semCurrentPage');
    var urlEl = document.getElementById('semCurrentUrl');
    var titleEl = document.getElementById('semCurrentTitle');
    container.classList.remove('hidden');
    urlEl.href = url;
    urlEl.textContent = url;
    titleEl.textContent = title ? '- ' + title : '';
  },

  refreshScreenshot: function() {
    if (!this.sessionId) return;
    var self = this;
    fetch('/v1/sessions/' + this.sessionId + '/screenshot')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.image) {
          if (data.image && data.image.indexOf('data:image/') === 0) {
            var _simg = document.createElement('img');
            _simg.src = data.image;
            _simg.alt = 'screenshot';
            self.screenshotHtml = _simg.outerHTML;
          }
          if (self.rightTab === 'screenshot') self.renderRightContent();
        }
      }).catch(function() {});
  },

  doAction: function(action, elementId, value) {
    var self = this;
    self.addLog('Executing ' + action + ': ' + elementId, 'info');
    fetch('/v1/sessions/' + self.sessionId + '/action', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: action, elementId: elementId, value: value })
    }).then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        self.addLog('Success! Page: ' + (data.page?.title || '-'), 'success');
        self.updateCurrentPage(data.page?.url || '', data.page?.title || '');
        setTimeout(function() { self.refreshElements(); }, 800);
      } else {
        self.addLog('Failed: ' + (data.error?.message || 'Unknown error'), 'error');
      }
    }).catch(function(err) {
      self.addLog('Network error: ' + err.message, 'error');
    });
  },

  showTypeModal: function(elementId) {
    this.pendingTypeElementId = elementId;
    document.getElementById('typeModal').classList.remove('hidden');
    document.getElementById('typeValue').focus();
  },

  closeTypeModal: function() {
    document.getElementById('typeModal').classList.add('hidden');
    document.getElementById('typeValue').value = '';
    this.pendingTypeElementId = null;
  },

  confirmType: function() {
    var value = document.getElementById('typeValue').value;
    if (this.pendingTypeElementId && value) {
      this.doAction('type', this.pendingTypeElementId, value);
    }
    this.closeTypeModal();
  },

  refreshElements: function() {
    var self = this;
    self.showStatus('Refreshing elements...', 'loading');
    fetch('/v1/sessions/' + self.sessionId + '/semantic')
      .then(function(r) { return r.json(); })
      .then(function(semData) {
        self.currentElements = semData.elements || [];
        self.renderFilterBar();
        if (self.leftTab === 'elements') self.renderLeftContent();
        self.showStats(semData);
        self.updateCurrentPage(semData.page?.url || '', semData.page?.title || '');
        self.refreshScreenshot();
        self.showStatus('Refreshed: ' + (semData.page?.title || '-'), 'success');
      }).catch(function(err) {
        self.showStatus('Refresh failed: ' + err.message, 'error');
      });
  },

  closeSession: function() {
    var self = this;
    if (!self.sessionId) return;
    fetch('/v1/sessions/' + self.sessionId, { method: 'DELETE' })
      .then(function() {
        self.sessionId = null;
        self.currentElements = [];
        self.rawMarkdown = '';
        self.screenshotHtml = '';
        document.getElementById('semStatsBar').classList.add('hidden');
        document.getElementById('semCurrentPage').classList.add('hidden');
        document.getElementById('semFilterBar').classList.add('hidden');
        document.getElementById('semRefreshBtn').style.display = 'none';
        document.getElementById('semSendToAgent').style.display = 'none';
        self.renderLeftContent();
        self.renderRightContent();
        self.showStatus('Session closed', 'success');
        updateHeaderButtons();
      });
  },

  analyze: function() {
    var self = this;
    var url = document.getElementById('semUrlInput').value.trim();
    if (!url) { self.showStatus('Please enter a URL', 'error'); return; }

    var btn = document.getElementById('semAnalyzeBtn');
    btn.disabled = true;
    btn.textContent = 'Analyzing...';

    // Close old session
    var closePromise = self.sessionId
      ? fetch('/v1/sessions/' + self.sessionId, { method: 'DELETE' })
      : Promise.resolve();

    closePromise.then(function() {
      self.showStatus('Creating browser session...', 'loading');
      var settings = loadSettings();
      var sessionOpts = {};
      if (settings.headless === false) sessionOpts.headless = false;
      return fetch('/v1/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sessionOpts)
      });
    }).then(function(r) {
      if (!r.ok) throw new Error('Failed to create session: ' + r.status);
      return r.json();
    })
    .then(function(sessionData) {
      self.sessionId = sessionData.sessionId;
      self.showStatus('Navigating to target...', 'loading');
      return fetch('/v1/sessions/' + self.sessionId + '/navigate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: url })
      });
    }).then(function(r) { return r.json(); })
    .then(function(navData) {
      if (!navData.success) throw new Error(navData.error?.message || 'Navigation failed');
      self.showStatus('Extracting semantic elements...', 'loading');
      return Promise.all([
        fetch('/v1/sessions/' + self.sessionId + '/semantic').then(function(r) { return r.json(); }),
        fetch('/v1/sessions/' + self.sessionId + '/content').then(function(r) { return r.json(); })
      ]);
    }).then(function(results) {
      var semData = results[0];
      var contentData = results[1];

      self.currentElements = semData.elements || [];
      self.renderFilterBar();
      self.showStats(semData);
      self.updateCurrentPage(semData.page?.url || url, semData.page?.title || '');

      self.rawMarkdown = self.generateMarkdown(url, semData, contentData);
      self.renderLeftContent();
      self.renderRightContent();
      self.refreshScreenshot();

      document.getElementById('semRefreshBtn').style.display = 'inline-block';
      document.getElementById('semSendToAgent').style.display = 'inline-block';
      updateHeaderButtons();

      self.showStatus('Analysis complete!', 'success');
      self.addLog('Loaded ' + (semData.elements?.length || 0) + ' elements', 'success');
    }).catch(function(err) {
      self.showStatus('Error: ' + err.message, 'error');
    }).finally(function() {
      btn.disabled = false;
      btn.textContent = 'Analyze';
    });
  },

  generateMarkdown: function(url, semData, contentData) {
    var lines = [];
    lines.push('# AI Browser Semantic Analysis\n');
    lines.push('> Time: ' + new Date().toLocaleString() + '\n');

    lines.push('## Page Info\n');
    lines.push('| Property | Value |');
    lines.push('|----------|-------|');
    lines.push('| URL | ' + (semData.page?.url || url) + ' |');
    lines.push('| Title | ' + (semData.page?.title || '-') + ' |');
    lines.push('| Type | `' + (semData.page?.type || 'unknown') + '` |');
    lines.push('| Summary | ' + (semData.page?.summary || '-') + ' |');
    lines.push('');

    var elements = semData.elements || [];
    var typeCount = {};
    elements.forEach(function(el) { typeCount[el.type] = (typeCount[el.type] || 0) + 1; });

    lines.push('## Element Stats\n');
    lines.push('Total **' + elements.length + '** interactive elements:\n');
    lines.push('| Type | Count |');
    lines.push('|------|-------|');
    Object.keys(typeCount).forEach(function(type) {
      lines.push('| ' + type + ' | ' + typeCount[type] + ' |');
    });
    lines.push('');

    lines.push('## Elements (first 20)\n');
    elements.slice(0, 20).forEach(function(el, i) {
      var label = el.label || '(no label)';
      var actions = el.actions?.join(', ') || '-';
      lines.push((i + 1) + '. **[' + el.type + ']** ' + label);
      lines.push('   - ID: `' + el.id + '`');
      lines.push('   - Actions: ' + actions);
      if (el.bounds && el.bounds.width > 0) {
        lines.push('   - Position: (' + Math.round(el.bounds.x) + ', ' + Math.round(el.bounds.y) + ') ' + Math.round(el.bounds.width) + 'x' + Math.round(el.bounds.height));
      }
      lines.push('');
    });

    var regions = semData.regions || [];
    if (regions.length > 0) {
      lines.push('## Page Regions\n');
      regions.forEach(function(region) {
        lines.push('- **' + region.name + '**: ' + (region.role || '-'));
      });
      lines.push('');
    }

    if (contentData) {
      lines.push('## Content Summary\n');
      if (contentData.title) lines.push('**Title**: ' + contentData.title + '\n');
      if (contentData.text) {
        var text = contentData.text.slice(0, 500).replace(/\n+/g, ' ').trim();
        lines.push('**Preview**: ' + text + (contentData.text.length > 500 ? '...' : '') + '\n');
      }
      if (contentData.links?.length > 0) lines.push('**Links**: ' + contentData.links.length + '\n');
    }

    lines.push('## JSON Sample\n');
    lines.push('```json');
    lines.push(JSON.stringify(elements.slice(0, 3), null, 2));
    lines.push('```\n');

    return lines.join('\n');
  }
};
</script>

<script>
// ========== Agent View ==========
var Agent = {
  agentId: null,
  sessionId: null,
  eventSource: null,
  previewMode: 'markdown',
  mdHistory: [],
  MAX_HISTORY: 10,
  currentMdContent: null,
  latestScreenshotHtml: '',
  conversationHistory: [],
  currentTask: '',

  switchPreview: function(mode) {
    this.previewMode = mode;
    document.getElementById('agentTabMd').classList.toggle('active', mode === 'markdown');
    document.getElementById('agentTabSs').classList.toggle('active', mode === 'screenshot');
    this.renderPreview();
  },

  renderPreview: function() {
    var body = document.getElementById('previewBody');
    if (this.previewMode === 'screenshot') {
      body.className = 'preview-body screenshot-mode';
      body.innerHTML = this.latestScreenshotHtml || '<div class="placeholder-text">Waiting for screenshot...</div>';
    } else {
      body.className = 'preview-body';
      this.renderMarkdownPreview(body);
    }
  },

  renderMarkdownPreview: function(container) {
    if (!this.currentMdContent && this.mdHistory.length === 0) {
      container.innerHTML = '<div class="placeholder-text">Waiting for Agent output...</div>';
      return;
    }
    var html = '';
    if (this.currentMdContent) {
      html += '<div class="md-current"><div class="markdown-body">' + safeMd(this.currentMdContent.content) + '</div></div>';
    }
    if (this.mdHistory.length > 0) {
      html += '<div class="md-history"><div style="color:var(--text-muted);font-size:11px;margin-bottom:6px;">History (' + this.mdHistory.length + ')</div>';
      for (var i = this.mdHistory.length - 1; i >= 0; i--) {
        var item = this.mdHistory[i];
        var id = 'hist_' + i;
        html += '<div class="md-history-item"><button class="md-history-toggle" onclick="Agent.toggleHistory(\'' + id + '\', this)"><span class="arrow">&#9654;</span> <span>' + esc(item.label) + '</span></button><div class="md-history-content" id="' + id + '"><div class="markdown-body">' + safeMd(item.content) + '</div></div></div>';
      }
      html += '</div>';
    }
    container.innerHTML = html;
  },

  toggleHistory: function(id, btn) {
    document.getElementById(id).classList.toggle('open');
    btn.classList.toggle('open');
  },

  pushMdContent: function(label, content) {
    if (this.currentMdContent) {
      this.mdHistory.push(this.currentMdContent);
      if (this.mdHistory.length > this.MAX_HISTORY) this.mdHistory.shift();
    }
    this.currentMdContent = { label: label, content: content };
    if (this.previewMode === 'markdown') this.renderPreview();
  },

  _generation: 0,
  _resultCounter: 0,

  // ===== Agent lifecycle =====
  start: function() {
    var self = this;
    var task = document.getElementById('taskInput').value.trim();
    if (!task) return;

    self._generation++;
    var gen = self._generation;
    var settings = loadSettings();

    // Reset right panel
    self.currentMdContent = null;
    self.mdHistory = [];
    self.latestScreenshotHtml = '';
    document.getElementById('previewUrl').textContent = '';
    self.renderPreview();

    // Remove placeholder
    var ph = document.getElementById('chatMessages').querySelector('.placeholder-text');
    if (ph) ph.remove();

    document.getElementById('sendBtn').disabled = true;
    document.getElementById('btnStop').style.display = 'inline-block';
    document.getElementById('taskInput').value = '';

    self.addMsg('user', task);
    self.currentTask = task;
    self.showTyping(true);

    var body = { task: task };
    if (settings.apiKey) body.apiKey = settings.apiKey;
    if (settings.baseURL) body.baseURL = settings.baseURL;
    if (settings.model) body.model = settings.model;
    if (settings.maxIterations) body.maxIterations = settings.maxIterations;
    if (settings.headless === false) body.headless = false;
    if (self.conversationHistory.length > 0) body.messages = self.conversationHistory;

    fetch('/v1/agent/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    }).then(function(r) { return r.json(); })
    .then(function(data) {
      if (gen !== self._generation) return; // stale request after stop
      if (!data.agentId) throw new Error(data.error?.message || 'Failed to start agent');
      self.agentId = data.agentId;
      updateHeaderButtons();
      self.connectSSE(data.agentId);
    }).catch(function(err) {
      if (gen !== self._generation) return;
      self.addMsg('error', err.message);
      self.resetUI();
    });
  },

  stop: function() {
    this._generation++;
    if (this.eventSource) { this.eventSource.close(); this.eventSource = null; }
    this.addMsg('system', 'Agent stopped');
    this.resetUI();
  },

  resetUI: function() {
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('btnStop').style.display = 'none';
    this.agentId = null;
    this.showTyping(false);
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('progressInfo').classList.remove('active');
    document.getElementById('progressFill').style.width = '0%';
    updateHeaderButtons();
  },

  clearChat: function() {
    if (this.eventSource) { this.eventSource.close(); this.eventSource = null; }
    document.getElementById('chatMessages').innerHTML = '<div class="placeholder-text">Enter a task to start</div>';
    this.currentMdContent = null;
    this.mdHistory = [];
    this.latestScreenshotHtml = '';
    this.sessionId = null;
    this.conversationHistory = [];
    this.currentTask = '';
    document.getElementById('previewUrl').textContent = '';
    document.getElementById('agentViewElements').style.display = 'none';
    this.renderPreview();
    this.resetUI();
    ChatStore.clear();
  },

  showTyping: function(show) {
    document.getElementById('typingIndicator').classList.toggle('visible', show);
  },
};
</script>

<script>
// ===== Agent SSE + Events =====
Agent.connectSSE = function(id) {
  var self = this;
  self.eventSource = new EventSource('/v1/agent/' + id + '/events');
  self.eventSource.onmessage = function(e) {
    self.handleEvent(JSON.parse(e.data));
  };
  self.eventSource.onerror = function() {
    self.eventSource.close();
    self.eventSource = null;
    if (self.agentId) {
      self.addMsg('error', 'Connection lost');
      self.resetUI();
    }
  };
};

Agent.handleEvent = function(ev) {
  var self = this;
  switch (ev.type) {
    case 'session_created':
      self.sessionId = ev.sessionId;
      App.sharedSessionId = ev.sessionId;
      self.addMsg('system', 'Session created');
      document.getElementById('agentViewElements').style.display = 'inline-block';
      self.refreshScreenshot();
      break;
    case 'thinking':
      self.showTyping(true);
      self.addMsg('thinking', ev.content, ev.iteration);
      break;
    case 'tool_call':
      self.showTyping(true);
      self.addMsg('tool_call', ev.name, ev.iteration, ev.args);
      break;
    case 'tool_result':
      self.showTyping(false);
      self.addMsg('tool_result', ev.summary, ev.iteration, ev.success, ev.name);
      self.pushMdContent('Step ' + ev.iteration + ' - ' + ev.name, self.formatMdResult(ev.name, ev.summary));
      self.refreshScreenshot();
      break;
    case 'error':
      self.showTyping(false);
      self.addMsg('error', ev.message, ev.iteration);
      break;
    case 'input_required':
      self.showTyping(false);
      self.addMsg('system', 'Agent is waiting for your input...');
      self.showInputDialog(ev.requestId, ev.question, ev.fields);
      break;
    case 'progress':
      if (ev.progress) {
        var p = ev.progress;
        document.getElementById('progressFill').style.width = p.percent + '%';
        document.getElementById('progressPhase').textContent = p.phase || '';
        document.getElementById('progressPercent').textContent = p.percent + '%';
        document.getElementById('progressSteps').textContent =
          (p.stepsRemaining != null && p.stepsRemaining > 0) ? '~' + p.stepsRemaining + ' steps left' : '';
        document.getElementById('progressBar').classList.add('active');
        document.getElementById('progressInfo').classList.add('active');
      }
      break;
    case 'done':
      self.addMsg('done', ev.success ? (ev.result || 'Done') : (ev.error || 'Failed'), null, ev.success);
      var summary = 'Total steps: ' + ev.iterations;
      if (ev.tokenUsage && ev.tokenUsage.total) {
        var tu = ev.tokenUsage;
        summary += ' | Tokens: ' + tu.total.toLocaleString() + ' (in: ' + tu.input.toLocaleString() + ' / out: ' + tu.output.toLocaleString() + ')';
      }
      self.addMsg('system', summary);
      if (self.currentTask) {
        self.conversationHistory.push({ role: 'user', content: self.currentTask });
        self.conversationHistory.push({ role: 'assistant', content: ev.result || ev.error || 'Done' });
        if (self.conversationHistory.length > 20) {
          self.conversationHistory = self.conversationHistory.slice(-20);
        }
        self.currentTask = '';
      }
      self.refreshScreenshot();
      self.resetUI();
      if (self.eventSource) { self.eventSource.close(); self.eventSource = null; }
      break;
  }
};
</script>

<script>
// ===== Agent message rendering =====
Agent.addMsg = function(type, content, iteration, extra, extra2) {
  var container = document.getElementById('chatMessages');
  var ph = container.querySelector('.placeholder-text');
  if (ph) ph.remove();

  var el = document.createElement('div');
  el.className = 'msg';
  var self = this;

  switch (type) {
    case 'user':
      el.className = 'msg msg-user';
      el.innerHTML = '<div class="bubble">' + esc(content) + '</div>';
      break;
    case 'system':
      el.className = 'msg msg-system';
      el.textContent = '\u2014 ' + content + ' \u2014';
      break;
    case 'thinking':
      el.className = 'msg msg-thinking';
      el.innerHTML = this.stepTag(iteration) + '<div class="md-inline markdown-body">' + safeMd(content || '') + '</div>';
      break;
    case 'tool_call':
      el.className = 'msg msg-tool-call';
      var desc = self.humanizeToolCall(content, extra);
      el.innerHTML = self.stepTag(iteration) +
        '<div class="tool-header"><span class="tool-icon">\u25B6</span> <span class="tool-desc">' + esc(desc) + '</span></div>' +
        '<details class="tool-raw"><summary>Raw params</summary><pre>' + esc(JSON.stringify(extra, null, 2)) + '</pre></details>';
      break;
    case 'tool_result':
      el.className = 'msg msg-tool-result ' + (extra ? 'success' : 'fail');
      var lbl = extra ? 'Result' : 'Error';
      var clr = extra ? '#3fb950' : '#f85149';
      var mdContent = this.formatMdResult(extra2 || lbl, content);
      var resultId = 'result_' + (++this._resultCounter);
      el.innerHTML = this.stepTag(iteration) +
        '<span style="color:' + clr + ';font-weight:600;">' + esc(extra2 || lbl) + '</span>' +
        '<div class="result-content" id="' + resultId + '"><div class="markdown-body">' + safeMd(mdContent) + '</div></div>' +
        '<button class="expand-btn" onclick="Agent.toggleExpand(\'' + resultId + '\', this)">Show more</button>';
      // Check if needs expand after render
      setTimeout(function() {
        var rc = document.getElementById(resultId);
        if (rc && rc.scrollHeight > 130) {
          rc.classList.add('needs-expand');
          rc.nextElementSibling.classList.add('visible');
        }
      }, 50);
      break;
    case 'error':
      el.className = 'msg msg-error';
      el.innerHTML = (iteration ? this.stepTag(iteration) : '') + 'Error: ' + esc(content);
      break;
    case 'done':
      el.className = 'msg msg-done ' + (extra ? 'success' : 'fail');
      var title = extra ? 'Task Completed' : 'Task Failed';
      var tc = extra ? '#3fb950' : '#f85149';
      el.innerHTML = '<div class="title" style="color:' + tc + '">' + title + '</div><div class="markdown-body">' + safeMd(content || '') + '</div>';
      break;
  }

  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
  ChatStore.save();
};

Agent.toggleExpand = function(id, btn) {
  var el = document.getElementById(id);
  var expanded = el.classList.toggle('expanded');
  btn.textContent = expanded ? 'Show less' : 'Show more';
};

Agent.stepTag = function(n) {
  if (n == null) return '';
  return '<span class="step-tag">Step ' + n + '</span>';
};

Agent.humanizeToolCall = function(name, args) {
  args = args || {};
  var map = {
    navigate: function(a) { return 'Navigate: ' + (a.url || ''); },
    click: function(a) { return 'Click: ' + (a.elementId || a.element_id || ''); },
    type_text: function(a) { return 'Type: "' + (a.text || '').slice(0, 40) + '"'; },
    get_page_info: function() { return 'Get page elements'; },
    get_page_content: function() { return 'Extract page content'; },
    find_element: function(a) { return 'Search: "' + (a.query || '') + '"'; },
    screenshot: function() { return 'Take screenshot'; },
    scroll: function(a) { return 'Scroll ' + (a.direction || 'down'); },
    press_key: function(a) { return 'Press key: ' + (a.key || ''); },
    select_option: function(a) { return 'Select: ' + (a.value || a.text || ''); },
    fill_form: function(a) { return 'Fill form (' + (a.fields ? a.fields.length : 0) + ' fields)'; },
    click_and_wait: function(a) { return 'Click & wait: ' + (a.element_id || ''); },
    navigate_and_extract: function(a) { return 'Navigate & extract: ' + (a.url || ''); },
    hover: function(a) { return 'Hover: ' + (a.elementId || a.element_id || ''); },
    go_back: function() { return 'Go back'; },
    wait: function(a) { return 'Wait: ' + (a.condition || (a.ms + 'ms')); },
    wait_for_stable: function() { return 'Wait for page stable'; },
    done: function(a) { return 'Done: ' + (a.result || '').slice(0, 50); },
    set_value: function(a) { return 'Set value: ' + (a.elementId || a.element_id || ''); },
    upload_file: function() { return 'Upload file'; },
    execute_javascript: function() { return 'Execute JavaScript'; },
    create_tab: function() { return 'Create new tab'; },
    list_tabs: function() { return 'List tabs'; },
    switch_tab: function(a) { return 'Switch to tab ' + (a.tabId || ''); },
    close_tab: function() { return 'Close tab'; },
  };
  var fn = map[name];
  return fn ? fn(args) : name;
};
</script>

<script>
// ===== Agent formatMdResult + screenshot + input dialog =====
Agent.formatMdResult = function(toolName, summary) {
  try {
    var obj = JSON.parse(summary);
    // Priority 1: use aiMarkdown from backend MCP enrichment layer
    if (typeof obj.aiMarkdown === 'string' && obj.aiMarkdown.length > 0) {
      return '## ' + toolName + '\n\n' + obj.aiMarkdown;
    }
    // Priority 2: use aiSummary as fallback
    if (typeof obj.aiSummary === 'string' && obj.aiSummary.length > 0) {
      return '## ' + toolName + '\n\n' + obj.aiSummary;
    }
    // Priority 3: manual formatting for tools without aiMarkdown
    if (toolName === 'get_page_info' && obj.elements) {
      var md = '## Page: ' + (obj.page?.title || '') + '\n\n';
      md += '**URL:** ' + (obj.page?.url || '') + '\n\n';
      md += '**Elements:** ' + obj.elementCount + '\n\n';
      md += '| ID | Type | Label |\n|---|---|---|\n';
      (obj.elements || []).forEach(function(el) {
        md += '| `' + el.id + '` | ' + el.type + ' | ' + (el.label || '-') + ' |\n';
      });
      return md;
    }
    if (toolName === 'navigate' && obj.page) {
      return '## Navigate\n\n**URL:** ' + (obj.page?.url || '') + '\n\n**Title:** ' + (obj.page?.title || '');
    }
    // Fallback: compact JSON
    return '## ' + toolName + '\n\n```json\n' + JSON.stringify(obj, null, 2) + '\n```';
  } catch (e) {
    return '## ' + toolName + '\n\n```\n' + summary + '\n```';
  }
};

Agent.refreshScreenshot = function() {
  var self = this;
  if (!self.sessionId) return;
  var body = document.getElementById('previewBody');
  if (self.previewMode === 'screenshot') body.classList.add('screenshot-loading');
  fetch('/v1/sessions/' + self.sessionId + '/screenshot')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.image && data.image.indexOf('data:image/') === 0) {
        var _img = document.createElement('img');
        _img.src = data.image;
        _img.alt = 'screenshot';
        self.latestScreenshotHtml = _img.outerHTML;
      }
      return fetch('/v1/sessions/' + self.sessionId);
    }).then(function(r) { return r.json(); })
    .then(function(info) {
      if (info.tabs && info.tabs.length > 0) {
        var tab = info.tabs.find(function(t) { return t.id === info.activeTabId; }) || info.tabs[0];
        document.getElementById('previewUrl').textContent = tab.url || '';
      }
      body.classList.remove('screenshot-loading');
      if (self.previewMode === 'screenshot') {
        self.renderPreview();
        body.classList.add('screenshot-updated');
        setTimeout(function() { body.classList.remove('screenshot-updated'); }, 400);
      }
    }).catch(function() { body.classList.remove('screenshot-loading'); });
};
</script>

<script>
// ===== Agent input dialog (ask_human) =====
Agent.showInputDialog = function(requestId, question, fields) {
  var existing = document.getElementById('inputModal');
  if (existing) existing.remove();

  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'inputModal';

  var modal = document.createElement('div');
  modal.className = 'modal';

  var h2 = document.createElement('h2');
  h2.textContent = question;
  modal.appendChild(h2);

  fields.forEach(function(field) {
    var label = document.createElement('label');
    label.textContent = field.label;
    modal.appendChild(label);

    var input = document.createElement('input');
    input.type = field.type || 'text';
    input.id = 'input_field_' + field.name;
    input.setAttribute('data-field-name', field.name);
    input.setAttribute('data-field-type', field.type);
    input.placeholder = field.label;
    modal.appendChild(input);
  });

  var btns = document.createElement('div');
  btns.className = 'modal-btns';

  var cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.onclick = function() { Agent.cancelInput(requestId); };
  btns.appendChild(cancelBtn);

  var submitBtn = document.createElement('button');
  submitBtn.className = 'btn btn-save';
  submitBtn.textContent = 'Submit';
  submitBtn.onclick = function() { Agent.submitInput(requestId); };
  btns.appendChild(submitBtn);

  modal.appendChild(btns);
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
};

Agent.submitInput = function(requestId) {
  var modal = document.getElementById('inputModal');
  if (!modal) return;
  var btns = modal.querySelectorAll('button');
  btns.forEach(function(b) { b.disabled = true; });

  var inputs = modal.querySelectorAll('input[data-field-name]');
  var response = {};
  var displayParts = [];
  inputs.forEach(function(input) {
    var name = input.getAttribute('data-field-name');
    var type = input.getAttribute('data-field-type');
    response[name] = input.value;
    displayParts.push(name + ': ' + (type === 'password' ? '***' : input.value));
  });

  var self = this;
  fetch('/v1/agent/' + self.agentId + '/input', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ requestId: requestId, response: response }),
  }).then(function() {
    self.addMsg('system', 'Submitted: ' + displayParts.join(', '));
    modal.remove();
  }).catch(function(err) {
    self.addMsg('error', 'Submit failed: ' + err.message);
    btns.forEach(function(b) { b.disabled = false; });
  });
};

Agent.cancelInput = function(requestId) {
  var modal = document.getElementById('inputModal');
  if (!modal) return;
  var self = this;
  fetch('/v1/agent/' + self.agentId + '/input', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ requestId: requestId, response: { error: 'User cancelled input' } }),
  }).catch(function() {});
  self.addMsg('system', 'Input cancelled');
  modal.remove();
};
</script>

<script>
// ===== ChatStore: localStorage persistence =====
var CHAT_STORE_KEY = 'ai_browser_chat_history';
var ChatStore = {
  _saveTimer: null,
  save: function() {
    if (ChatStore._saveTimer) clearTimeout(ChatStore._saveTimer);
    ChatStore._saveTimer = setTimeout(ChatStore._doSave, 500);
  },
  _doSave: function() {
    ChatStore._saveTimer = null;
    try {
      var msgs = [];
      var container = document.getElementById('chatMessages');
      container.querySelectorAll('.msg').forEach(function(el) {
        var type = '';
        if (el.classList.contains('msg-user')) type = 'user';
        else if (el.classList.contains('msg-system')) type = 'system';
        else if (el.classList.contains('msg-thinking')) type = 'thinking';
        else if (el.classList.contains('msg-tool-call')) type = 'tool_call';
        else if (el.classList.contains('msg-tool-result')) type = 'tool_result';
        else if (el.classList.contains('msg-error')) type = 'error';
        else if (el.classList.contains('msg-done')) type = 'done';
        if (type) msgs.push({ type: type, html: el.outerHTML });
      });
      if (msgs.length === 0) return;
      if (msgs.length > 50) msgs = msgs.slice(-50);
      var data = {
        messages: msgs,
        conversationHistory: Agent.conversationHistory,
        savedAt: Date.now()
      };
      localStorage.setItem(CHAT_STORE_KEY, JSON.stringify(data));
    } catch(e) { /* quota exceeded or other error */ }
  },
  load: function() {
    try {
      var raw = localStorage.getItem(CHAT_STORE_KEY);
      if (!raw) return;
      var data = JSON.parse(raw);
      if (!data.messages || data.messages.length === 0) return;
      var container = document.getElementById('chatMessages');
      var ph = container.querySelector('.placeholder-text');
      if (ph) ph.remove();
      data.messages.forEach(function(m) {
        var wrapper = document.createElement('div');
        wrapper.innerHTML = DOMPurify.sanitize(m.html);
        if (wrapper.firstChild) container.appendChild(wrapper.firstChild);
      });
      if (data.conversationHistory) {
        Agent.conversationHistory = data.conversationHistory;
      }
    } catch(e) { /* parse error */ }
  },
  clear: function() {
    localStorage.removeItem(CHAT_STORE_KEY);
  }
};
</script>

<script>
// ===== Tasks: SPA integration =====
var Tasks = {
  pollTimer: null,
  currentTaskId: null,

  refreshList: function() {
    var list = document.getElementById('tasksList');
    list.innerHTML = '<div class="placeholder-text">Loading...</div>';
    document.getElementById('taskDetail').style.display = 'none';
    document.getElementById('taskCreate').style.display = 'none';
    fetch('/v1/tasks').then(function(r) { return r.json(); }).then(function(data) {
      var tasks = data.tasks || [];
      if (tasks.length === 0) {
        list.innerHTML = '<div class="placeholder-text">No tasks yet. Click "+ New Task" to create one.</div>';
        return;
      }
      list.innerHTML = '';
      tasks.forEach(function(t) {
        var card = document.createElement('div');
        card.className = 'task-card';
        card.onclick = function() { Tasks.showResult(t.taskId); };
        var safeStatus = ['running','done','pending','failed'].indexOf(t.status) >= 0 ? t.status : 'pending';
        var statusCls = 'task-status ' + safeStatus;
        card.innerHTML = '<div class="' + statusCls + '">' + esc(t.status || 'unknown') + '</div>' +
          '<div style="font-weight:500;margin:6px 0">' + esc((t.goal || '').slice(0, 80)) + '</div>' +
          '<div style="font-size:12px;color:var(--text-muted)">' + new Date(t.createdAt).toLocaleString() + '</div>';
        list.appendChild(card);
      });
    }).catch(function() {
      list.innerHTML = '<div class="placeholder-text">Failed to load tasks.</div>';
    });
  },

  showCreate: function() {
    document.getElementById('tasksList').style.display = 'none';
    document.getElementById('taskDetail').style.display = 'none';
    var panel = document.getElementById('taskCreate');
    panel.style.display = 'block';
    panel.innerHTML =
      '<h3 style="margin:0 0 16px">New Task</h3>' +
      '<div class="task-create-form">' +
        '<label>Goal</label>' +
        '<textarea id="tcGoal" rows="3" placeholder="Describe what you want the agent to do..."></textarea>' +
        '<label>Start URL (optional)</label>' +
        '<input type="text" id="tcUrl" placeholder="https://...">' +
        '<label>Max Steps</label>' +
        '<input type="number" id="tcMaxSteps" value="20" min="1" max="200">' +
        '<div style="display:flex;gap:8px;margin-top:12px">' +
          '<button class="btn btn-primary" onclick="Tasks.submitTask()">Run Task</button>' +
          '<button class="btn" onclick="Tasks.backToList()">Cancel</button>' +
        '</div>' +
      '</div>';
  },

  backToList: function() {
    document.getElementById('taskCreate').style.display = 'none';
    document.getElementById('taskDetail').style.display = 'none';
    document.getElementById('tasksList').style.display = '';
    Tasks.refreshList();
  },

  submitTask: function() {
    var goal = document.getElementById('tcGoal').value.trim();
    if (!goal) return;
    var url = document.getElementById('tcUrl').value.trim();
    var maxSteps = parseInt(document.getElementById('tcMaxSteps').value) || 20;
    if (url) goal = goal + '\nStart URL: ' + url;

    var cfg = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
    var body = {
      goal: goal,
      maxIterations: maxSteps,
      apiKey: cfg.apiKey || undefined,
      baseURL: cfg.baseURL || undefined,
      model: cfg.model || undefined,
      headless: cfg.headless !== undefined ? cfg.headless : true,
    };

    fetch('/v1/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    }).then(function(r) { return r.json(); }).then(function(data) {
      if (data.taskId) {
        Tasks.showResult(data.taskId);
      } else {
        alert('Failed to create task: ' + JSON.stringify(data));
      }
    }).catch(function(err) {
      alert('Error: ' + err.message);
    });
  },

  showResult: function(taskId) {
    Tasks.currentTaskId = taskId;
    document.getElementById('tasksList').style.display = 'none';
    document.getElementById('taskCreate').style.display = 'none';
    var panel = document.getElementById('taskDetail');
    panel.style.display = 'block';
    panel.innerHTML = '<div class="placeholder-text">Loading task...</div>';

    fetch('/v1/tasks/' + taskId).then(function(r) { return r.json(); }).then(function(data) {
      var safeStatus = ['running','done','pending','failed'].indexOf(data.status) >= 0 ? data.status : 'pending';
      var statusCls = 'task-status ' + safeStatus;
      var html = '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">' +
        '<button class="btn" onclick="Tasks.backToList()">&larr; Back</button>' +
        '<span class="' + statusCls + '">' + esc(data.status || '') + '</span>' +
        '<span style="font-size:12px;color:var(--text-muted)">' + esc(taskId.slice(0, 8)) + '</span>' +
      '</div>';
      html += '<div style="margin-bottom:12px"><strong>Goal:</strong> ' + esc(data.goal || '(unknown)') + '</div>';
      if (data.result) {
        html += '<div style="margin-bottom:12px"><strong>Result:</strong></div>' +
          '<pre style="background:var(--bg-secondary);padding:12px;border-radius:6px;overflow:auto;max-height:300px">' +
          esc(typeof data.result === 'string' ? data.result : JSON.stringify(data.result, null, 2)) + '</pre>';
      }
      if (data.error) {
        html += '<div style="color:var(--danger)"><strong>Error:</strong> ' + esc(data.error) + '</div>';
      }
      html += '<div id="taskEvents" style="margin-top:16px"></div>';
      panel.innerHTML = html;

      if (data.status === 'running') {
        Tasks.pollStatus(taskId);
      }
    }).catch(function() {
      panel.innerHTML = '<div class="placeholder-text">Failed to load task.</div>' +
        '<button class="btn" onclick="Tasks.backToList()" style="margin-top:12px">&larr; Back</button>';
    });
  },

  pollStatus: function(taskId) {
    if (Tasks.pollTimer) clearInterval(Tasks.pollTimer);
    Tasks.pollTimer = setInterval(function() {
      if (Tasks.currentTaskId !== taskId) {
        clearInterval(Tasks.pollTimer);
        Tasks.pollTimer = null;
        return;
      }
      fetch('/v1/tasks/' + taskId).then(function(r) { return r.json(); }).then(function(data) {
        if (data.status !== 'running') {
          clearInterval(Tasks.pollTimer);
          Tasks.pollTimer = null;
          Tasks.showResult(taskId);
        }
      }).catch(function() {});
    }, 3000);
  }
};
</script>

<script>
// ===== Keyboard shortcuts =====
document.getElementById('taskInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && !document.getElementById('sendBtn').disabled) Agent.start();
});

document.getElementById('semUrlInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') Sem.analyze();
});

// Event delegation for semantic element action buttons (avoids XSS via inline onclick)
document.getElementById('semLeftContent').addEventListener('click', function(e) {
  var btn = e.target.closest('[data-sem-action]');
  if (!btn) return;
  var action = btn.getAttribute('data-sem-action');
  var id = btn.getAttribute('data-sem-id');
  if (action === 'click') Sem.doAction('click', id);
  else if (action === 'type') Sem.showTypeModal(id);
});

// Event delegation for filter bar buttons
document.getElementById('semFilterBar').addEventListener('click', function(e) {
  var btn = e.target.closest('[data-filter]');
  if (!btn) return;
  Sem.setFilter(btn.getAttribute('data-filter'));
});

// Enter key on type modal
document.getElementById('typeValue').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') Sem.confirmType();
});
</script>

<script>
// ========== Init ==========
(function() {
  var hash = location.hash.replace('#', '');
  var view = (hash === 'agent') ? 'agent' : (hash === 'tasks') ? 'tasks' : 'semantic';
  switchView(view);
  ChatStore.load();
})();
</script>
</body>
</html>
