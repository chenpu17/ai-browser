<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Browser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <style>
/* ===== CSS Design System ===== */
:root {
  --bg-canvas: #0a0e14;
  --bg-surface: #12171f;
  --bg-overlay: #1a2030;
  --bg-elevated: #1e2536;
  --border: #252d3a;
  --border-subtle: #1c2333;
  --border-accent: rgba(99,160,255,0.2);
  --text-primary: #d4dae4;
  --text-secondary: #8892a2;
  --text-muted: #4a5568;
  --accent: #63a0ff;
  --accent-dim: rgba(99,160,255,0.12);
  --accent-glow: rgba(99,160,255,0.25);
  --green: #22c55e;
  --green-dim: rgba(34,197,94,0.12);
  --green-hover: #16a34a;
  --red: #ef4444;
  --red-dim: rgba(239,68,68,0.12);
  --blue: #3b82f6;
  --blue-dim: rgba(59,130,246,0.12);
  --purple: #a78bfa;
  --purple-dim: rgba(167,139,250,0.12);
  --orange: #fb923c;
  --orange-dim: rgba(251,146,60,0.12);
  --yellow: #facc15;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.15);
  --shadow: 0 2px 8px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.2);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.4), 0 2px 6px rgba(0,0,0,0.2);
  --shadow-glow: 0 0 20px rgba(99,160,255,0.08);
  --transition: 180ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-canvas);
  background-image: radial-gradient(ellipse at 50% 0%, rgba(99,160,255,0.03) 0%, transparent 60%);
  color: var(--text-primary);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ===== Header / Nav ===== */
.app-header {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  display: flex;
  align-items: center;
  height: 52px;
  flex-shrink: 0;
  gap: 16px;
  box-shadow: 0 1px 8px rgba(0,0,0,0.2);
  position: relative;
  z-index: 10;
}
.app-logo {
  color: var(--accent);
  font-size: 15px;
  font-weight: 700;
  white-space: nowrap;
  letter-spacing: -0.3px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.nav-tabs {
  display: flex;
  gap: 2px;
  margin-left: 8px;
  background: var(--bg-canvas);
  border-radius: var(--radius-md);
  padding: 3px;
}
.nav-tab {
  padding: 6px 16px;
  font-size: 13px;
  font-weight: 500;
  border: none;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
}
.nav-tab .tab-icon { font-size: 14px; margin-right: 2px; }
.nav-tab:hover { color: var(--text-primary); background: var(--bg-overlay); }
.nav-tab.active {
  color: var(--accent);
  background: var(--bg-overlay);
  box-shadow: var(--shadow-sm);
}
.nav-tab.active::after {
  display: none;
}
.header-right {
  display: flex;
  gap: 8px;
  margin-left: auto;
}

/* ===== Shared Button Styles ===== */
.btn {
  padding: 7px 14px;
  font-size: 13px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 500;
  transition: all var(--transition);
  background: var(--bg-overlay);
  color: var(--text-primary);
  white-space: nowrap;
  box-shadow: var(--shadow-sm);
}
.btn:hover { border-color: var(--accent); color: var(--accent); background: var(--bg-elevated); }
.btn-primary {
  background: linear-gradient(135deg, var(--green), var(--green-hover));
  color: #fff;
  border-color: transparent;
  box-shadow: 0 2px 8px rgba(34,197,94,0.2);
}
.btn-primary:hover { background: linear-gradient(135deg, var(--green-hover), #15803d); border-color: transparent; color: #fff; box-shadow: 0 2px 12px rgba(34,197,94,0.3); }
.btn-primary:disabled {
  background: var(--bg-overlay);
  color: var(--text-muted);
  border-color: var(--border);
  cursor: not-allowed;
  box-shadow: none;
}
.btn-danger { border-color: var(--red); color: var(--red); }
.btn-danger:hover { background: var(--red); color: #fff; box-shadow: 0 2px 8px rgba(239,68,68,0.25); }
.btn-send {
  padding: 10px 24px;
  background: linear-gradient(135deg, var(--accent), #4f8ef7);
  color: #fff;
  border: none;
  border-radius: var(--radius-lg);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(99,160,255,0.25);
  transition: all var(--transition);
}
.btn-send:hover { box-shadow: 0 4px 16px rgba(99,160,255,0.35); transform: translateY(-1px); }
.btn-send:disabled { background: var(--bg-overlay); color: var(--text-muted); cursor: not-allowed; box-shadow: none; transform: none; }

/* ===== Main Layout ===== */
.app-main {
  flex: 1;
  overflow: hidden;
  position: relative;
}
.view {
  display: none;
  position: absolute;
  inset: 0;
  flex-direction: column;
}
.view.active {
  display: flex;
  animation: viewFadeIn 200ms ease;
}
@keyframes viewFadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== Shared Modal ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
.modal-overlay.hidden { display: none; }
.modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 28px;
  width: 440px;
  max-width: 90vw;
  box-shadow: var(--shadow-lg), var(--shadow-glow);
}
.modal h2 { font-size: 16px; color: var(--text-primary); margin-bottom: 16px; font-weight: 600; }
.modal label {
  display: block;
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 4px;
  margin-top: 14px;
}
.modal label:first-of-type { margin-top: 0; }
.modal input[type="text"],
.modal input[type="password"],
.modal input[type="number"] {
  width: 100%;
  padding: 9px 12px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
  transition: all var(--transition);
}
.modal input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
.modal-btns {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}
.btn-save { background: linear-gradient(135deg, var(--green), var(--green-hover)); color: #fff; border-color: transparent; box-shadow: 0 2px 8px rgba(34,197,94,0.2); }
.btn-save:hover { background: linear-gradient(135deg, var(--green-hover), #15803d); color: #fff; }

/* ===== Shared Markdown ===== */
.markdown-body {
  background: transparent !important;
  color: var(--text-primary) !important;
}
.markdown-body pre { background: var(--bg-surface) !important; }
.markdown-body code { background: var(--bg-overlay) !important; }
.markdown-body table { font-size: 13px; }
</style>
<style>
/* ===== Semantic View Styles ===== */
#view-semantic .sem-toolbar {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-shrink: 0;
}
#view-semantic .sem-toolbar input[type="text"] {
  flex: 1;
  padding: 9px 14px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
  transition: all var(--transition);
}
#view-semantic .sem-toolbar input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }

.sem-stats-bar {
  background: var(--bg-overlay);
  border-bottom: 1px solid var(--border);
  padding: 7px 20px;
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: var(--text-secondary);
  flex-shrink: 0;
}
.sem-stats-bar .stat-item {
  display: flex;
  align-items: center;
  gap: 5px;
}
.sem-stats-bar .stat-val {
  color: var(--accent);
  font-weight: 600;
}
.sem-stats-bar.hidden { display: none; }

.sem-body {
  flex: 1;
  display: flex;
  overflow: hidden;
  padding-bottom: 28px;
}
.sem-left {
  width: 60%;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  overflow: hidden;
}
.sem-right {
  width: 40%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sem-content-tabs {
  display: flex;
  gap: 2px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
}
.sem-content-tab {
  padding: 5px 12px;
  font-size: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
}
.sem-content-tab.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

.sem-content-area {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.sem-right-tabs {
  display: flex;
  gap: 2px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
}

.sem-right-area {
  flex: 1;
  overflow: auto;
}
.sem-right-area.screenshot-mode {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #010409;
  padding: 12px;
}
.sem-right-area img {
  max-width: 100%;
  max-height: 100%;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}
.sem-right-area .raw-output {
  padding: 16px;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 13px;
  white-space: pre-wrap;
  word-break: break-all;
  color: var(--text-secondary);
}

/* Element list */
.element-list { padding: 0; }
.element-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 6px;
  background: var(--bg-canvas);
  transition: all var(--transition);
}
.element-item:hover { border-color: var(--accent); background: var(--bg-surface); box-shadow: 0 0 0 1px var(--accent-dim); }
.element-info { flex: 1; min-width: 0; }
.element-type {
  display: inline-block;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
  margin-right: 8px;
  letter-spacing: 0.3px;
}
.element-type.button { background: var(--green-dim); color: var(--green); }
.element-type.link { background: var(--blue-dim); color: var(--accent); }
.element-type.textbox { background: var(--purple-dim); color: var(--purple); }
.element-type.checkbox { background: var(--orange-dim); color: var(--orange); }
.element-label { font-weight: 500; color: var(--text-primary); font-size: 13px; }
.element-id {
  font-size: 11px;
  color: #6e7681;
  font-family: monospace;
  margin-top: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
}
.element-actions { display: flex; gap: 4px; }
.btn-action {
  padding: 4px 10px;
  font-size: 12px;
  background: var(--bg-overlay);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition);
}
.btn-action:hover { background: var(--border); }
.btn-action.btn-click { border-color: var(--green); }
.btn-action.btn-click:hover { background: var(--green); color: #fff; }
.btn-action.btn-type { border-color: var(--purple); }
.btn-action.btn-type:hover { background: var(--purple); color: #fff; }

.filter-bar {
  display: flex;
  gap: 6px;
  padding: 8px 16px;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
}
.filter-bar.hidden { display: none; }
.filter-btn {
  padding: 4px 10px;
  font-size: 11px;
  background: var(--bg-overlay);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition);
}
.filter-btn.active { background: var(--blue-dim); color: var(--accent); border-color: var(--accent); }

/* Log drawer */
.sem-log-drawer {
  border-top: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
  max-height: 0;
  overflow: hidden;
  transition: max-height 200ms ease;
}
.sem-log-drawer.open { max-height: 180px; }
.sem-log-toggle {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 28px;
  background: var(--bg-overlay);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 11px;
  color: var(--text-secondary);
  z-index: 2;
}
.sem-log-toggle:hover { color: var(--text-primary); }
.sem-log-entries {
  padding: 8px 16px;
  overflow-y: auto;
  max-height: 150px;
  font-family: monospace;
  font-size: 12px;
}
.log-entry { padding: 3px 0; border-bottom: 1px solid var(--bg-overlay); }
.log-entry:last-child { border-bottom: none; }
.log-time { color: #6e7681; }
.log-success { color: #3fb950; }
.log-error { color: #f85149; }
.log-info { color: var(--accent); }

.sem-status {
  padding: 6px 20px;
  font-size: 12px;
  flex-shrink: 0;
  display: none;
}
.sem-status.visible { display: block; }
.sem-status.loading { background: var(--accent-dim); color: var(--accent); }
.sem-status.success { background: var(--green-dim); color: var(--green); }
.sem-status.error { background: var(--red-dim); color: var(--red); }

.placeholder-text {
  color: var(--text-muted);
  font-size: 14px;
  text-align: center;
  padding: 48px 20px;
  line-height: 1.6;
}
</style>
<style>
/* ===== Agent View Styles ===== */
#view-agent .agent-main { display: flex; flex: 1; overflow: hidden; }

.chat-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.chat-input-bar {
  border-top: 1px solid var(--border);
  padding: 14px 16px;
  display: flex;
  gap: 10px;
  background: var(--bg-surface);
}
.chat-input-bar input {
  flex: 1;
  padding: 10px 16px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
  transition: all var(--transition);
}
.chat-input-bar input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }

/* Preview panel */
.preview-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
}
.preview-header {
  background: var(--bg-surface);
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.preview-tabs { display: flex; gap: 4px; }
.preview-tab {
  padding: 5px 14px;
  font-size: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
}
.preview-tab.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
.preview-url {
  font-size: 12px;
  color: var(--accent);
  margin-left: auto;
  max-width: 50%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.preview-body {
  flex: 1;
  overflow: auto;
  background: var(--bg-canvas);
}
.preview-body.screenshot-mode {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #010409;
  padding: 12px;
  position: relative;
}
.screenshot-loading::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 1;
}
.screenshot-loading::after {
  content: '';
  position: absolute;
  width: 24px; height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  z-index: 2;
}
@keyframes spin { to { transform: rotate(360deg); } }
.screenshot-updated { box-shadow: inset 0 0 0 2px var(--accent); transition: box-shadow 0.3s ease; }
.preview-body img {
  max-width: 100%;
  max-height: 100%;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

/* Markdown preview areas */
.md-current { padding: 16px; }
.md-history {
  border-top: 1px solid var(--border);
  padding: 8px 16px;
}
.md-history-item {
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 6px;
  overflow: hidden;
}
.md-history-toggle {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-surface);
  border: none;
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 6px;
}
.md-history-toggle:hover { color: var(--text-primary); }
.md-history-toggle .arrow { transition: transform 0.2s; }
.md-history-toggle.open .arrow { transform: rotate(90deg); }
.md-history-content {
  display: none;
  padding: 12px;
  max-height: 300px;
  overflow: auto;
}
.md-history-content.open { display: block; }
.md-history-content .markdown-body { font-size: 13px; }

/* Chat message styles */
.msg { margin-bottom: 10px; }
.msg-user { text-align: right; }
.msg-user .bubble {
  display: inline-block;
  background: linear-gradient(135deg, var(--blue), #2563eb);
  color: #fff;
  padding: 10px 16px;
  border-radius: 16px 16px 4px 16px;
  max-width: 85%;
  text-align: left;
  font-size: 14px;
  animation: fadeIn 200ms ease;
  box-shadow: 0 2px 8px rgba(59,130,246,0.2);
}
.msg-system {
  text-align: center;
  color: var(--text-muted);
  font-size: 12px;
  padding: 4px 0;
}
.msg-thinking {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 10px 14px;
  font-size: 13px;
  color: var(--text-secondary);
  font-style: italic;
  animation: fadeIn 200ms ease;
  border-left: 3px solid var(--accent);
}
.msg-thinking .markdown-body { font-style: normal; font-size: 13px; }
.msg .md-inline { font-style: normal; }
.msg-tool-call {
  background: var(--bg-canvas);
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius-lg);
  padding: 10px 14px;
  font-size: 13px;
  animation: fadeIn 200ms ease;
}
.msg-tool-call .tool-header {
  display: flex;
  align-items: center;
  gap: 6px;
}
.msg-tool-call .tool-icon {
  font-size: 12px;
  color: var(--accent);
}
.msg-tool-call .label { color: var(--accent); font-weight: 600; }
.msg-tool-call .tool-desc { color: var(--text-primary); font-size: 13px; }
.msg-tool-call details.tool-raw {
  margin-top: 4px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.msg-tool-call details.tool-raw summary {
  padding: 3px 8px;
  font-size: 11px;
  color: var(--text-muted);
  cursor: pointer;
  background: var(--bg-surface);
}
.msg-tool-call details.tool-raw summary:hover { color: var(--text-secondary); }
.msg-tool-call details.tool-raw pre {
  margin: 0;
  padding: 6px 8px;
  font-size: 11px;
}
.msg-tool-call pre {
  margin: 4px 0 0;
  color: var(--text-primary);
  font-size: 12px;
  white-space: pre-wrap;
  word-break: break-all;
}

/* Collapsible tool result */
.msg-tool-result {
  background: var(--bg-canvas);
  border-radius: var(--radius-lg);
  padding: 8px 12px;
  font-size: 13px;
  animation: fadeIn 200ms ease;
}
.msg-tool-result.success { border: 1px solid var(--border); border-left: 3px solid var(--green); }
.msg-tool-result.fail { border: 1px solid var(--border); border-left: 3px solid var(--red); }
.msg-tool-result .result-content {
  max-height: 120px;
  overflow: hidden;
  position: relative;
  transition: max-height 200ms ease;
}
.msg-tool-result .result-content.expanded { max-height: none; }
.msg-tool-result .result-content.needs-expand::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 30px;
  background: linear-gradient(transparent, var(--bg-canvas));
  pointer-events: none;
}
.msg-tool-result .result-content.expanded::after { display: none; }
.msg-tool-result .expand-btn {
  display: none;
  margin-top: 4px;
  font-size: 11px;
  color: var(--accent);
  cursor: pointer;
  background: none;
  border: none;
  padding: 2px 0;
}
.msg-tool-result .expand-btn.visible { display: inline-block; }
.msg-tool-result pre {
  margin: 4px 0 0;
  color: var(--text-secondary);
  font-size: 12px;
  white-space: pre-wrap;
  word-break: break-all;
}

.msg-error {
  background: var(--red-dim);
  border: 1px solid var(--border);
  border-left: 3px solid var(--red);
  border-radius: var(--radius-lg);
  padding: 10px 14px;
  font-size: 13px;
  color: #fca5a5;
  animation: fadeIn 200ms ease;
}
.msg-done {
  border-radius: var(--radius-lg);
  padding: 14px 18px;
  font-size: 14px;
  animation: fadeIn 200ms ease;
}
.msg-done.success { background: var(--green-dim); border: 1px solid var(--green); border-left: 4px solid var(--green); }
.msg-done.fail { background: var(--red-dim); border: 1px solid var(--red); border-left: 4px solid var(--red); }
.msg-done .title { font-weight: 700; margin-bottom: 4px; }
.msg-done .markdown-body { font-size: 14px; }

.msg-memory-recall {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(59, 130, 246, 0.08));
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-left: 3px solid #8b5cf6;
  border-radius: var(--radius-lg);
  padding: 10px 14px;
  font-size: 13px;
  color: #c4b5fd;
  animation: fadeIn 200ms ease;
}
.memory-recall-hint {
  display: flex;
  align-items: center;
  gap: 6px;
}
.memory-recall-hint .memory-icon {
  font-size: 16px;
}
.memory-recall-hint strong {
  color: #a78bfa;
}

.step-tag {
  display: inline-block;
  background: var(--accent-dim);
  color: var(--accent);
  font-size: 11px;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  margin-right: 6px;
  font-style: normal;
  font-weight: 600;
}

/* Progress bar */
.progress-bar-wrap {
  height: 3px;
  background: var(--bg-overlay);
  border-radius: 2px;
  overflow: hidden;
  margin: 0;
  display: none;
}
.progress-bar-wrap.active { display: block; }
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--purple));
  border-radius: 2px;
  transition: width 0.4s ease;
  width: 0%;
  box-shadow: 0 0 8px rgba(99,160,255,0.4);
}
.progress-info {
  display: none;
  font-size: 11px;
  color: var(--text-muted);
  padding: 4px 16px;
  gap: 12px;
  background: var(--bg-surface);
}
.progress-info.active { display: flex; align-items: center; }
.progress-phase { text-transform: capitalize; color: var(--text-secondary); }
.progress-percent { color: var(--accent); font-weight: 600; }

/* Typing indicator */
.typing-indicator {
  display: none;
  padding: 8px 0;
}
.typing-indicator.visible { display: flex; gap: 4px; align-items: center; padding-left: 4px; }
.typing-dot {
  width: 6px;
  height: 6px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typingBounce 1.2s infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-4px); opacity: 1; }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Type input modal (semantic view) */
.type-input-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.type-input-modal.hidden { display: none; }
.type-input-modal .modal-content {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 28px;
  width: 400px;
  box-shadow: var(--shadow-lg), var(--shadow-glow);
}
.type-input-modal .modal-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
}
.type-input-modal .modal-input {
  width: 100%;
  padding: 10px 14px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
  margin-bottom: 16px;
  transition: all var(--transition);
}
.type-input-modal .modal-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
.type-input-modal .modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* ===== Tasks View Styles ===== */
.tasks-toolbar {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-shrink: 0;
}
.tasks-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 12px;
  align-content: start;
}
.task-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  cursor: pointer;
  transition: all var(--transition);
  box-shadow: var(--shadow-sm);
}
.task-card:hover { border-color: var(--accent); box-shadow: var(--shadow), 0 0 0 1px var(--accent-dim); transform: translateY(-1px); }
.task-card .task-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.task-card .task-id {
  font-size: 11px;
  color: var(--text-muted);
  font-family: monospace;
}
.task-status {
  display: inline-block;
  padding: 3px 10px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.3px;
}
.task-status.running { background: var(--accent-dim); color: var(--accent); }
.task-status.done { background: var(--green-dim); color: var(--green); }
.task-status.failed { background: var(--red-dim); color: var(--red); }
.task-status.pending { background: var(--bg-overlay); color: var(--text-muted); }
.task-card .task-goal {
  font-size: 14px;
  color: var(--text-primary);
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.task-card .task-meta {
  font-size: 12px;
  color: var(--text-muted);
}
.task-detail {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.task-detail-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.task-detail-back {
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  font-size: 14px;
  padding: 4px 8px;
}
.task-detail-back:hover { text-decoration: underline; }
.task-detail .meta-grid {
  display: grid;
  grid-template-columns: 120px 1fr;
  row-gap: 8px;
  font-size: 14px;
  margin-bottom: 16px;
}
.task-detail .meta-key { color: var(--text-muted); }
.task-detail pre {
  background: var(--bg-canvas);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 12px;
  overflow: auto;
  max-height: 400px;
  font-size: 13px;
  white-space: pre-wrap;
  word-break: break-all;
}
.task-create-form {
  max-width: 600px;
}
.task-create-form label {
  display: block;
  font-size: 13px;
  color: var(--text-secondary);
  margin: 12px 0 4px;
}
.task-create-form input,
.task-create-form textarea {
  width: 100%;
  padding: 9px 12px;
  font-size: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-canvas);
  color: var(--text-primary);
  outline: none;
  transition: all var(--transition);
}
.task-create-form input:focus,
.task-create-form textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
.task-create-form textarea { min-height: 80px; resize: vertical; }
.task-create-form .form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.task-create-form .form-actions {
  margin-top: 16px;
  display: flex;
  gap: 8px;
}

/* ===== Memory View Styles ===== */
.memory-toolbar {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-shrink: 0;
}
.memory-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 12px;
  align-content: start;
}
.memory-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  cursor: pointer;
  transition: all var(--transition);
  box-shadow: var(--shadow-sm);
}
.memory-card:hover { border-color: var(--accent); box-shadow: var(--shadow), 0 0 0 1px var(--accent-dim); transform: translateY(-1px); }
.memory-card .memory-domain {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.memory-card .memory-domain .site-type {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  background: var(--purple-dim);
  color: var(--purple);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.memory-card .memory-domain .login-badge {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  background: var(--orange-dim);
  color: var(--orange);
}
.memory-card .memory-meta {
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 8px;
}
.memory-card .memory-patterns {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.memory-card .pattern-tag {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  background: var(--bg-overlay);
  color: var(--text-secondary);
  border: 1px solid var(--border-subtle);
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.memory-detail {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.memory-detail-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.memory-detail .pattern-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.memory-detail .pattern-item {
  background: var(--bg-canvas);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 12px 14px;
  transition: all var(--transition);
}
.memory-detail .pattern-item:hover { border-color: var(--border); background: var(--bg-surface); }
.memory-detail .pattern-type {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  margin-right: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.memory-detail .pattern-type.selector { background: var(--green-dim); color: var(--green); }
.memory-detail .pattern-type.navigation_path { background: var(--blue-dim); color: var(--accent); }
.memory-detail .pattern-type.login_required { background: var(--orange-dim); color: var(--orange); }
.memory-detail .pattern-type.spa_hint { background: var(--purple-dim); color: var(--purple); }
.memory-detail .pattern-type.page_structure { background: var(--accent-dim); color: var(--accent); }
.memory-detail .pattern-desc { font-size: 13px; color: var(--text-primary); margin-top: 4px; }
.memory-detail .pattern-value {
  font-size: 12px;
  font-family: 'Monaco', 'Menlo', monospace;
  color: var(--text-secondary);
  margin-top: 4px;
  padding: 4px 8px;
  background: var(--bg-overlay);
  border-radius: var(--radius-sm);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.memory-detail .pattern-meta {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  display: flex;
  gap: 12px;
}
.memory-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: var(--text-muted);
  text-align: center;
}
.memory-empty .empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

/* ===== Recording View ===== */
.rec-state { display: none; }
.rec-state.active { display: flex; flex-direction: column; height: 100%; }

.rec-state.rec-setup {
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  gap: 20px;
}
.rec-setup .rec-url-row {
  display: flex;
  gap: 8px;
  width: 100%;
  max-width: 600px;
}
.rec-setup .rec-url-row input {
  flex: 1;
}
.rec-setup .rec-hint {
  font-size: 13px;
  color: var(--text-muted);
  text-align: center;
  max-width: 480px;
  line-height: 1.6;
}

.rec-split {
  display: flex;
  flex: 1;
  overflow: hidden;
}
.rec-left-panel {
  width: 50%;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.rec-right-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Recording indicator bar */
.rec-indicator-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  background: var(--bg-overlay);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.rec-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--red);
  animation: recPulse 1.2s ease-in-out infinite;
}
@keyframes recPulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
  50% { opacity: 0.6; box-shadow: 0 0 0 6px rgba(239,68,68,0); }
}
.rec-indicator-bar .rec-timer {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
}
.rec-indicator-bar .rec-event-count {
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: auto;
}
.rec-indicator-bar .btn-danger {
  flex-shrink: 0;
}

/* Event stream */
.rec-event-stream {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}
.rec-event-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 16px;
  font-size: 12px;
  color: var(--text-secondary);
  animation: recFadeIn 0.3s ease;
}
@keyframes recFadeIn {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}
.rec-event-item .ev-icon {
  font-size: 14px;
  width: 20px;
  text-align: center;
  flex-shrink: 0;
}
.rec-event-item .ev-badge {
  font-size: 10px;
  padding: 1px 6px;
  border-radius: 3px;
  font-weight: 600;
  text-transform: uppercase;
  flex-shrink: 0;
}
.ev-badge.navigate { background: var(--blue-dim); color: var(--blue); }
.ev-badge.click { background: var(--green-dim); color: var(--green); }
.ev-badge.type { background: var(--purple-dim); color: var(--purple); }
.ev-badge.select { background: var(--orange-dim); color: var(--orange); }
.ev-badge.scroll { background: var(--accent-dim); color: var(--accent); }
.rec-event-item .ev-desc {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.rec-event-item .ev-time {
  font-size: 10px;
  color: var(--text-muted);
  flex-shrink: 0;
}

/* Screenshot preview */
.rec-preview-header, .rec-review-header {
  padding: 10px 16px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.rec-preview-body {
  flex: 1;
  overflow: auto;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 12px;
  background: var(--bg-canvas);
}
.rec-preview-body img {
  max-width: 100%;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}
.rec-preview-body .skeleton {
  width: 100%;
  aspect-ratio: 16/10;
  background: linear-gradient(90deg, var(--bg-overlay) 25%, var(--bg-elevated) 50%, var(--bg-overlay) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: var(--radius-sm);
}
@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Review state */
.rec-summary {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  flex-shrink: 0;
}
.rec-summary .sum-item {
  font-size: 12px;
  color: var(--text-secondary);
}
.rec-summary .sum-item strong {
  color: var(--text-primary);
  font-weight: 600;
}
.rec-timeline {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}
.rec-patterns-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
}
.rec-pattern-item {
  padding: 10px 12px;
  background: var(--bg-overlay);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  font-size: 12px;
}
.rec-pattern-item .pat-type {
  font-size: 10px;
  padding: 1px 6px;
  border-radius: 3px;
  font-weight: 600;
  background: var(--accent-dim);
  color: var(--accent);
  margin-right: 6px;
}
.rec-pattern-item .pat-desc {
  color: var(--text-primary);
  margin-top: 4px;
}
.rec-pattern-item .pat-value {
  color: var(--text-muted);
  font-family: monospace;
  font-size: 11px;
  margin-top: 4px;
  word-break: break-all;
}
.rec-intent-section {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}
.rec-intent-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.rec-intent-hint {
  font-weight: 400;
  text-transform: none;
  letter-spacing: 0;
  color: var(--text-muted);
  font-size: 11px;
}
.rec-intent-textarea {
  width: 100%;
  min-height: 80px;
  max-height: 200px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-canvas);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 13px;
  line-height: 1.5;
  resize: vertical;
  box-sizing: border-box;
}
.rec-intent-textarea:focus {
  outline: none;
  border-color: var(--accent);
}
.rec-intent-textarea.loading {
  opacity: 0.5;
  background: repeating-linear-gradient(
    -45deg,
    var(--bg-canvas),
    var(--bg-canvas) 10px,
    var(--bg-overlay) 10px,
    var(--bg-overlay) 20px
  );
  background-size: 28px 28px;
  animation: recShimmer 1s linear infinite;
}
@keyframes recShimmer {
  to { background-position: 28px 0; }
}
.rec-actions {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  flex-shrink: 0;
}
.rec-success-msg {
  padding: 12px 16px;
  background: var(--green-dim);
  color: var(--green);
  font-size: 13px;
  border-radius: var(--radius-sm);
  margin: 12px 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.rec-empty-events {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  color: var(--text-muted);
  font-size: 13px;
  gap: 8px;
}

/* ===== Welcome Banner ===== */
.welcome-banner {
  background: linear-gradient(135deg, var(--bg-surface), var(--bg-elevated));
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 28px 32px;
  margin: 20px;
  position: relative;
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  animation: viewFadeIn 400ms ease;
}
.welcome-banner .welcome-close {
  position: absolute;
  top: 12px;
  right: 16px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 18px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  transition: all var(--transition);
}
.welcome-banner .welcome-close:hover { color: var(--text-primary); background: var(--bg-overlay); }
.welcome-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.welcome-title .logo-icon {
  font-size: 24px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.welcome-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.5;
}
.welcome-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}
.welcome-card {
  background: var(--bg-canvas);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  cursor: pointer;
  transition: all var(--transition);
  text-align: left;
  font-family: inherit;
  color: inherit;
}
.welcome-card:hover { border-color: var(--accent); background: var(--bg-overlay); transform: translateY(-2px); box-shadow: var(--shadow); }
.welcome-card .wc-icon { font-size: 22px; margin-bottom: 8px; }
.welcome-card .wc-name { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
.welcome-card .wc-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
.welcome-tip {
  margin-top: 16px;
  padding: 10px 14px;
  background: var(--accent-dim);
  border-radius: var(--radius-md);
  font-size: 12px;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ===== Onboarding Empty States ===== */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 24px;
  text-align: center;
  flex: 1;
}
.empty-state .es-icon { font-size: 48px; opacity: 0.25; margin-bottom: 12px; }
.empty-state .es-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
.empty-state .es-desc { font-size: 13px; color: var(--text-secondary); max-width: 420px; line-height: 1.6; margin-bottom: 16px; }
.empty-state .es-steps {
  text-align: left;
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 2;
  margin-bottom: 16px;
}
.empty-state .es-steps .step-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent-dim);
  color: var(--accent);
  font-size: 11px;
  font-weight: 600;
  margin-right: 8px;
}
.empty-state .es-examples {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
  margin-top: 4px;
}
.empty-state .es-example {
  font-size: 11px;
  padding: 4px 10px;
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
  font-family: inherit;
}
.empty-state .es-example:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }

/* ===== Responsive ===== */
@media (max-width: 900px) {
  .sem-body { flex-direction: column; padding-bottom: 28px; }
  .sem-left, .sem-right { width: 100%; border-right: none; }
  .sem-right { border-top: 1px solid var(--border); }
  #view-agent .agent-main { flex-direction: column; }
  .chat-panel, .preview-panel { width: 100%; border-right: none; }
  .preview-panel { border-top: 1px solid var(--border); }
  .tasks-list { grid-template-columns: 1fr; }
  .memory-list { grid-template-columns: 1fr !important; }
  .rec-split { flex-direction: column; }
  .rec-left-panel, .rec-right-panel { width: 100%; border-right: none; }
  .rec-right-panel { border-top: 1px solid var(--border); }
  .welcome-banner { margin: 12px; padding: 20px; }
  .welcome-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
}
@media (max-width: 768px) {
  .app-logo { font-size: 13px; }
  .nav-tab { padding: 5px 10px; font-size: 12px; }
  .preview-panel { max-height: 40vh; }
  .progress-info { padding: 3px 12px; font-size: 10px; }
  .modal { width: 95vw; padding: 16px; }
  .task-create-form .form-row { grid-template-columns: 1fr; }
}
@media (max-width: 480px) {
  .preview-panel { display: none; }
  .rec-right-panel { display: none; }
  .rec-left-panel { width: 100%; border-right: none; }
  .chat-panel { width: 100%; border-right: none; }
  .chat-input-bar input { font-size: 16px; padding: 12px 14px; }
  .msg-tool-result .result-content { max-height: 80px; }
  .header-right { gap: 4px; }
  .btn { padding: 5px 8px; font-size: 12px; }
  .tab-icon { display: none; }
  .welcome-banner { margin: 8px; padding: 16px; }
  .welcome-grid { grid-template-columns: 1fr 1fr; }
  .welcome-tip { flex-direction: column; text-align: center; }
}
  </style>
</head>
<body>
<!-- ===== Header ===== -->
<header class="app-header">
  <span class="app-logo">AI Browser</span>
  <div class="nav-tabs">
    <button class="nav-tab active" data-view="semantic" onclick="switchView('semantic')" title="Analyze page structure and elements"><span class="tab-icon">&#128270;</span> Semantic</button>
    <button class="nav-tab" data-view="agent" onclick="switchView('agent')" title="AI agent that browses the web for you"><span class="tab-icon">&#129302;</span> Agent</button>
    <button class="nav-tab" data-view="tasks" onclick="switchView('tasks')" title="Run deterministic task templates"><span class="tab-icon">&#128203;</span> Tasks</button>
    <button class="nav-tab" data-view="memory" onclick="switchView('memory')" title="Site knowledge learned from browsing"><span class="tab-icon">&#129504;</span> Memory</button>
    <button class="nav-tab" data-view="record" onclick="switchView('record')" title="Record browsing sessions to build memory"><span class="tab-icon">&#9210;</span> Record</button>
  </div>
  <div class="header-right" id="headerRight">
    <button class="btn" id="btnCloseSession" style="display:none" onclick="Sem.closeSession()">Close Session</button>
    <button class="btn btn-danger" id="btnStop" style="display:none" onclick="Agent.stop()">Stop</button>
    <button class="btn" id="btnClear" style="display:none" onclick="Agent.clearChat()">Clear</button>
    <button class="btn" id="btnSettings" onclick="openSettings()" title="Configure LLM provider (API key, model, base URL)">&#9881; Settings</button>
  </div>
</header>

<!-- ===== Welcome Banner ===== -->
<div class="welcome-banner" id="welcomeBanner" style="display:none;">
  <button class="welcome-close" onclick="dismissWelcome()" title="Dismiss" aria-label="Dismiss welcome banner">&times;</button>
  <div class="welcome-title"><span class="logo-icon">&#127760;</span> Welcome to AI Browser</div>
  <div class="welcome-subtitle">An AI-powered browser automation platform. Analyze pages, run autonomous agents, create repeatable tasks, and build site memory — all from one interface.</div>
  <div class="welcome-grid">
    <button class="welcome-card" onclick="dismissWelcome();switchView('semantic')">
      <div class="wc-icon">&#128270;</div>
      <div class="wc-name">Semantic</div>
      <div class="wc-desc">Open any URL and inspect its structure — interactive elements, markdown content, and screenshots.</div>
    </button>
    <button class="welcome-card" onclick="dismissWelcome();switchView('agent')">
      <div class="wc-icon">&#129302;</div>
      <div class="wc-name">Agent</div>
      <div class="wc-desc">Give a natural-language task. The AI agent opens a browser and completes it autonomously.</div>
    </button>
    <button class="welcome-card" onclick="dismissWelcome();switchView('tasks')">
      <div class="wc-icon">&#128203;</div>
      <div class="wc-name">Tasks</div>
      <div class="wc-desc">Create and run deterministic task templates — repeatable browser automations with artifacts.</div>
    </button>
    <button class="welcome-card" onclick="dismissWelcome();switchView('memory')">
      <div class="wc-icon">&#129504;</div>
      <div class="wc-name">Memory</div>
      <div class="wc-desc">View site knowledge cards — selectors, navigation paths, and patterns the system has learned.</div>
    </button>
    <button class="welcome-card" onclick="dismissWelcome();switchView('record')">
      <div class="wc-icon">&#9210;</div>
      <div class="wc-name">Record</div>
      <div class="wc-desc">Record your own browsing session. Your actions are captured and saved as reusable site memory.</div>
    </button>
  </div>
  <div class="welcome-tip">&#128161; First time? Start with <strong style="margin:0 4px;">Semantic</strong> to explore a page, or jump to <strong style="margin:0 4px;">Agent</strong> to let AI do the work. Configure your LLM in <strong style="margin:0 4px;">Settings</strong> (top right).</div>
</div>

<!-- ===== Main ===== -->
<main class="app-main">
  <!-- Semantic View -->
  <div id="view-semantic" class="view active">
    <!-- Toolbar -->
    <div class="sem-toolbar">
      <input type="text" id="semUrlInput" placeholder="Enter URL to analyze, e.g. https://www.baidu.com" value="https://www.baidu.com">
      <button class="btn btn-primary" id="semAnalyzeBtn" onclick="Sem.analyze()">Analyze</button>
      <button class="btn" id="semRefreshBtn" style="display:none" onclick="Sem.refreshElements()">Refresh</button>
      <button class="btn" id="semSendToAgent" style="display:none" onclick="sendToAgent()">Send to Agent</button>
    </div>

    <!-- Status bar -->
    <div class="sem-status" id="semStatus"></div>

    <!-- Current page info -->
    <div class="sem-stats-bar hidden" id="semCurrentPage" style="gap:8px;">
      <span style="color:var(--text-secondary)">Current:</span>
      <a id="semCurrentUrl" href="#" target="_blank" style="color:var(--accent);text-decoration:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%;"></a>
      <span id="semCurrentTitle" style="color:var(--text-secondary);"></span>
    </div>

    <!-- Stats bar -->
    <div class="sem-stats-bar hidden" id="semStatsBar"></div>

    <!-- Body: left + right columns -->
    <div class="sem-body">
      <!-- Left column (60%) -->
      <div class="sem-left">
        <div class="sem-content-tabs">
          <button class="sem-content-tab active" onclick="Sem.switchLeftTab('markdown', this)">Markdown</button>
          <button class="sem-content-tab" onclick="Sem.switchLeftTab('elements', this)">Elements</button>
        </div>
        <div class="filter-bar hidden" id="semFilterBar"></div>
        <div class="sem-content-area" id="semLeftContent">
          <div class="empty-state">
            <div class="es-icon">&#128270;</div>
            <div class="es-title">Semantic Page Analysis</div>
            <div class="es-desc">Enter a URL above and click Analyze. The page will be parsed into structured markdown and interactive elements — buttons, links, inputs — each with a semantic ID you can use to automate interactions.</div>
            <div class="es-steps">
              <div><span class="step-num">1</span>Enter a URL in the toolbar above</div>
              <div><span class="step-num">2</span>Click <strong>Analyze</strong> to open the page</div>
              <div><span class="step-num">3</span>Browse elements, click or type into them</div>
              <div><span class="step-num">4</span>Click <strong>Send to Agent</strong> to hand off the session</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column (40%) -->
      <div class="sem-right">
        <div class="sem-right-tabs" id="semRightTabs">
          <button class="sem-content-tab active" onclick="Sem.switchRightTab('screenshot', this)">Screenshot</button>
          <button class="sem-content-tab" onclick="Sem.switchRightTab('raw', this)">Raw Markdown</button>
        </div>
        <div class="sem-right-area" id="semRightContent">
          <div class="placeholder-text" style="padding:32px 20px;font-size:13px;">Screenshot and raw markdown will appear here after analysis.</div>
        </div>
      </div>
    </div>

    <!-- Log drawer toggle -->
    <div class="sem-log-toggle" onclick="Sem.toggleLog()">
      <span id="semLogToggleText">Show Log (0)</span>
    </div>
    <div class="sem-log-drawer" id="semLogDrawer">
      <div class="sem-log-entries" id="semLogEntries"></div>
    </div>
  </div>

  <!-- Agent View -->
  <div id="view-agent" class="view">
    <div class="agent-main">
      <!-- Left: Chat -->
      <div class="chat-panel">
        <div class="chat-messages" id="chatMessages">
          <div class="empty-state" id="agentEmptyState">
            <div class="es-icon">&#129302;</div>
            <div class="es-title">AI Browsing Agent</div>
            <div class="es-desc">Describe a task in natural language. The AI agent will open a browser, navigate pages, click buttons, fill forms, and extract information — all autonomously.</div>
            <div class="es-steps">
              <div><span class="step-num">1</span>Type a task in the input below</div>
              <div><span class="step-num">2</span>Click <strong>Send</strong> — the agent starts working</div>
              <div><span class="step-num">3</span>Watch progress in real-time on the right panel</div>
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Try an example:</div>
            <div class="es-examples">
              <button class="es-example" onclick="document.getElementById('taskInput').value=this.textContent;document.getElementById('taskInput').focus()">Open Baidu and search for weather</button>
              <button class="es-example" onclick="document.getElementById('taskInput').value=this.textContent;document.getElementById('taskInput').focus()">Go to GitHub trending and list top 5 repos</button>
              <button class="es-example" onclick="document.getElementById('taskInput').value=this.textContent;document.getElementById('taskInput').focus()">Search Amazon for wireless headphones under $50</button>
            </div>
          </div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <div class="progress-bar-wrap" id="progressBar">
          <div class="progress-bar-fill" id="progressFill"></div>
        </div>
        <div class="progress-info" id="progressInfo">
          <span class="progress-phase" id="progressPhase"></span>
          <span class="progress-percent" id="progressPercent"></span>
          <span id="progressSteps"></span>
        </div>
        <div class="chat-input-bar">
          <input type="text" id="taskInput" placeholder="Describe a task, e.g.: Open Baidu and search for weather, then summarize the results">
          <button class="btn-send" id="sendBtn" onclick="Agent.start()">Send</button>
        </div>
      </div>

      <!-- Right: Preview -->
      <div class="preview-panel">
        <div class="preview-header">
          <div class="preview-tabs">
            <button class="preview-tab active" id="agentTabMd" onclick="Agent.switchPreview('markdown')">Markdown</button>
            <button class="preview-tab" id="agentTabSs" onclick="Agent.switchPreview('screenshot')">Screenshot</button>
          </div>
          <button class="btn" id="agentViewElements" style="display:none" onclick="viewElementsFromAgent()">View Elements</button>
          <span class="preview-url" id="previewUrl"></span>
        </div>
        <div class="preview-body" id="previewBody">
          <div class="placeholder-text" style="padding:32px 20px;font-size:13px;">Page markdown and screenshots will appear here as the agent browses.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks View -->
  <div id="view-tasks" class="view">
    <div class="tasks-toolbar">
      <button class="btn btn-primary" id="btnNewTask" onclick="Tasks.showCreate()">+ New Task</button>
      <button class="btn" onclick="Tasks.refreshList()">Refresh</button>
      <span style="font-size:12px;color:var(--text-muted);margin-left:auto;">Run deterministic task templates — repeatable browser automations</span>
    </div>
    <div id="tasksList" class="tasks-list">
      <div class="empty-state" id="tasksEmptyState">
        <div class="es-icon">&#128203;</div>
        <div class="es-title">Task Templates</div>
        <div class="es-desc">Tasks are deterministic, repeatable browser automations. Create a task template with a URL and goal, then run it anytime. Unlike the Agent (which uses AI reasoning), tasks follow predefined steps.</div>
        <div class="es-steps">
          <div><span class="step-num">1</span>Click <strong>+ New Task</strong> to create a template</div>
          <div><span class="step-num">2</span>Set a URL, goal, and optional parameters</div>
          <div><span class="step-num">3</span>Run the task and view results with artifacts</div>
        </div>
      </div>
    </div>
    <div id="taskDetail" class="task-detail" style="display:none"></div>
    <div id="taskCreate" class="task-detail" style="display:none"></div>
  </div>

  <!-- Memory View -->
  <div id="view-memory" class="view">
    <div class="memory-toolbar">
      <button class="btn" onclick="Memory.refreshList()">Refresh</button>
      <span style="font-size:12px;color:var(--text-muted);margin-left:auto;">Site knowledge cards — selectors, navigation paths, and patterns learned from browsing</span>
    </div>
    <div id="memoryList" class="memory-list">
      <div class="placeholder-text">Loading memory...</div>
    </div>
    <div id="memoryDetail" class="memory-detail" style="display:none"></div>
  </div>

  <!-- Record View -->
  <div id="view-record" class="view">
    <!-- Setup State -->
    <div id="rec-setup" class="rec-state active rec-setup">
      <div style="font-size:36px;opacity:0.3;margin-bottom:8px">&#9679;</div>
      <div style="font-size:16px;font-weight:600;color:var(--text-primary)">Record a Browsing Session</div>
      <div class="rec-hint">Enter a URL to start recording. A browser window will open — interact with the page normally. Your actions will be captured and converted to site memory.</div>
      <div class="rec-url-row">
        <input type="text" id="recUrlInput" placeholder="https://example.com" value="">
        <button class="btn btn-primary" id="recStartBtn" onclick="Rec.start()">Start Recording</button>
      </div>
    </div>

    <!-- Recording State -->
    <div id="rec-active" class="rec-state">
      <div class="rec-split">
        <div class="rec-left-panel">
          <div class="rec-indicator-bar">
            <span class="rec-dot"></span>
            <span class="rec-timer" id="recTimer">00:00</span>
            <span class="rec-event-count" id="recEventCount">0 events</span>
            <button class="btn btn-danger" onclick="Rec.stop()">Stop Recording</button>
          </div>
          <div class="rec-event-stream" id="recEventStream">
            <div class="rec-empty-events">
              <span style="font-size:24px;opacity:0.3">&#128065;</span>
              <span>Waiting for interactions...</span>
            </div>
          </div>
        </div>
        <div class="rec-right-panel">
          <div class="rec-preview-header">Live Preview</div>
          <div class="rec-preview-body" id="recPreviewBody">
            <div class="skeleton"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Review State -->
    <div id="rec-review" class="rec-state">
      <div class="rec-split">
        <div class="rec-left-panel">
          <div class="rec-summary" id="recSummary"></div>
          <div class="rec-intent-section" id="recIntentSection">
            <div class="rec-intent-header">
              <span>Task Intent</span>
              <span class="rec-intent-hint" id="recIntentHint">AI summarizing...</span>
            </div>
            <textarea id="recIntentText" class="rec-intent-textarea" rows="6" maxlength="1000" aria-label="Task Intent" placeholder="LLM is analyzing your recording..."></textarea>
          </div>
          <div class="rec-timeline" id="recTimeline"></div>
        </div>
        <div class="rec-right-panel">
          <div class="rec-review-header">Extracted Patterns</div>
          <div class="rec-patterns-body" id="recPatternsBody">
            <div class="placeholder-text">No patterns extracted.</div>
          </div>
          <div id="recSuccessArea"></div>
          <div class="rec-actions" id="recActions">
            <button class="btn" onclick="Rec.discard()">Discard</button>
            <button class="btn btn-primary" id="recSaveBtn" onclick="Rec.saveToMemory()">Save to Memory</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<div class="modal-overlay hidden" id="settingsModal">
  <div class="modal">
    <h2>Model Settings</h2>
    <label>Base URL</label>
    <input type="text" id="cfgBaseURL" placeholder="https://api.openai.com/v1">
    <label>Model</label>
    <input type="text" id="cfgModel" placeholder="gpt-4">
    <label>API Key</label>
    <input type="password" id="cfgApiKey" placeholder="sk-...">
    <label>Max Iterations</label>
    <input type="number" id="cfgMaxIterations" placeholder="Default (server-controlled)" min="1" max="1000">
    <label>LLM Timeout (seconds)</label>
    <input type="number" id="cfgTimeout" placeholder="300" min="10" max="600">
    <label style="display:flex;align-items:center;gap:8px;margin-top:14px;cursor:pointer;">
      <input type="checkbox" id="cfgHeadless" checked style="width:auto;cursor:pointer;">
      Headless Mode
      <span style="color:var(--text-muted);font-size:12px;">(Turn off to see browser window for manual login)</span>
    </label>
    <div class="modal-btns">
      <button class="btn" onclick="closeSettings()">Cancel</button>
      <button class="btn" id="btnTestConn" onclick="testConnection()">Test Connection</button>
      <button class="btn btn-save" onclick="saveSettings()">Save</button>
    </div>
    <div id="connTestResult" style="margin-top:8px;font-size:12px;display:none;"></div>
  </div>
</div>

<!-- ===== Type Input Modal (semantic view) ===== -->
<div id="typeModal" class="type-input-modal hidden">
  <div class="modal-content">
    <div class="modal-title">Type Text</div>
    <input type="text" id="typeValue" class="modal-input" placeholder="Enter text to type">
    <div class="modal-buttons">
      <button class="btn" onclick="Sem.closeTypeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="Sem.confirmType()">Confirm</button>
    </div>
  </div>
</div>

<script>
// ========== Shared State ==========
var App = {
  currentView: 'semantic',
  sharedSessionId: null,
};

// ========== Shared Utilities ==========
function esc(s) {
  var d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function safeMd(s) {
  return DOMPurify.sanitize(marked.parse(s || ''));
}

// ========== Settings (localStorage, shared) ==========
var SETTINGS_KEY = 'ai_browser_agent_settings';

function loadSettings() {
  try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }
  catch(e) { return {}; }
}

function openSettings() {
  var s = loadSettings();
  document.getElementById('cfgBaseURL').value = s.baseURL || '';
  document.getElementById('cfgModel').value = s.model || '';
  document.getElementById('cfgApiKey').value = s.apiKey || '';
  document.getElementById('cfgMaxIterations').value = s.maxIterations || '';
  document.getElementById('cfgTimeout').value = s.timeout || '';
  document.getElementById('cfgHeadless').checked = s.headless !== false;
  document.getElementById('settingsModal').classList.remove('hidden');
}

function closeSettings() {
  document.getElementById('settingsModal').classList.add('hidden');
}

function saveSettings() {
  var settings = {
    baseURL: document.getElementById('cfgBaseURL').value.trim(),
    model: document.getElementById('cfgModel').value.trim(),
    apiKey: document.getElementById('cfgApiKey').value.trim(),
    maxIterations: parseInt(document.getElementById('cfgMaxIterations').value) || 0,
    timeout: parseInt(document.getElementById('cfgTimeout').value) || 0,
    headless: document.getElementById('cfgHeadless').checked,
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  closeSettings();
}

function testConnection() {
  var btn = document.getElementById('btnTestConn');
  var result = document.getElementById('connTestResult');
  btn.disabled = true;
  btn.textContent = 'Testing...';
  result.style.display = 'block';
  result.style.color = 'var(--text-muted)';
  result.textContent = 'Connecting...';

  var body = {
    baseURL: document.getElementById('cfgBaseURL').value.trim(),
    model: document.getElementById('cfgModel').value.trim(),
    apiKey: document.getElementById('cfgApiKey').value.trim(),
  };

  fetch('/v1/llm/test', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  }).then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.ok) {
      result.style.color = '#3fb950';
      result.textContent = '\u2713 Connected — ' + (data.model || 'OK') + ' (' + (data.latencyMs || '?') + 'ms)';
    } else {
      result.style.color = '#f85149';
      result.textContent = '\u2717 Failed: ' + (data.error || 'Unknown error');
    }
  }).catch(function(err) {
    result.style.color = '#f85149';
    result.textContent = '\u2717 ' + err.message;
  }).finally(function() {
    btn.disabled = false;
    btn.textContent = 'Test Connection';
  });
}

// ========== Navigation ==========
function switchView(view) {
  // Warn if leaving record view while recording or reviewing
  if (App.currentView === 'record' && view !== 'record' && Rec.state === 'recording') {
    if (!confirm('Recording is in progress. Leave and stop recording?')) return;
    Rec.stopPolling();
    Rec._stopBackendRecording();
    Rec.cleanup();
    Rec.reset();
  }
  if (App.currentView === 'record' && view !== 'record' && Rec.state === 'review') {
    Rec.cleanup();
    Rec.reset();
  }
  App.currentView = view;
  location.hash = view;
  // Clean up Tasks polling when leaving
  if (view !== 'tasks' && Tasks.pollTimer) {
    clearInterval(Tasks.pollTimer);
    Tasks.pollTimer = null;
  }
  document.getElementById('view-semantic').classList.toggle('active', view === 'semantic');
  document.getElementById('view-agent').classList.toggle('active', view === 'agent');
  document.getElementById('view-tasks').classList.toggle('active', view === 'tasks');
  document.getElementById('view-memory').classList.toggle('active', view === 'memory');
  document.getElementById('view-record').classList.toggle('active', view === 'record');
  // Update nav tabs
  document.querySelectorAll('.nav-tab').forEach(function(tab) {
    tab.classList.toggle('active', tab.getAttribute('data-view') === view);
  });
  if (view === 'tasks') Tasks.refreshList();
  if (view === 'memory') Memory.refreshList();
  if (view === 'record') {
    var saved = localStorage.getItem('rec_last_url');
    if (saved && !document.getElementById('recUrlInput').value) {
      document.getElementById('recUrlInput').value = saved;
    }
  }
  updateHeaderButtons();
}

function updateHeaderButtons() {
  var view = App.currentView;
  // Semantic buttons
  document.getElementById('btnCloseSession').style.display =
    (view === 'semantic' && Sem.sessionId) ? 'inline-block' : 'none';
  // Agent buttons
  document.getElementById('btnStop').style.display =
    (view === 'agent' && Agent.agentId) ? 'inline-block' : 'none';
  document.getElementById('btnClear').style.display =
    (view === 'agent') ? 'inline-block' : 'none';
  // Settings always visible
}

// Hash routing
window.addEventListener('hashchange', function() {
  var hash = location.hash.replace('#', '');
  var view = (hash === 'agent') ? 'agent' : (hash === 'tasks') ? 'tasks' : (hash === 'memory') ? 'memory' : (hash === 'record') ? 'record' : 'semantic';
  if (view !== App.currentView) switchView(view);
});

// Session sharing: Semantic -> Agent
function sendToAgent() {
  if (Sem.sessionId) {
    App.sharedSessionId = Sem.sessionId;
  }
  switchView('agent');
}

// Session sharing: Agent -> Semantic (view elements)
function viewElementsFromAgent() {
  if (Agent.sessionId) {
    App.sharedSessionId = Agent.sessionId;
  }
  switchView('semantic');
}

// Close modal on overlay click
document.getElementById('settingsModal').addEventListener('click', function(e) {
  if (e.target === this) closeSettings();
});
</script>

<script>
// ========== Semantic View ==========
var Sem = {
  sessionId: null,
  currentElements: [],
  currentFilter: 'all',
  pendingTypeElementId: null,
  leftTab: 'markdown',
  rightTab: 'screenshot',
  rawMarkdown: '',
  screenshotHtml: '',
  logCount: 0,

  showStatus: function(msg, type) {
    var el = document.getElementById('semStatus');
    el.className = 'sem-status visible ' + type;
    el.textContent = msg;
  },

  hideStatus: function() {
    document.getElementById('semStatus').className = 'sem-status';
  },

  addLog: function(message, type) {
    type = type || 'info';
    this.logCount++;
    var entries = document.getElementById('semLogEntries');
    var time = new Date().toLocaleTimeString();
    entries.innerHTML = '<div class="log-entry"><span class="log-time">[' + time + ']</span> <span class="log-' + esc(type) + '">' + esc(message) + '</span></div>' + entries.innerHTML;
    document.getElementById('semLogToggleText').textContent = 'Show Log (' + this.logCount + ')';
  },

  toggleLog: function() {
    var drawer = document.getElementById('semLogDrawer');
    drawer.classList.toggle('open');
    var isOpen = drawer.classList.contains('open');
    document.getElementById('semLogToggleText').textContent =
      (isOpen ? 'Hide' : 'Show') + ' Log (' + this.logCount + ')';
  },

  switchLeftTab: function(tab, btn) {
    this.leftTab = tab;
    btn.parentElement.querySelectorAll('.sem-content-tab').forEach(function(t) { t.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('semFilterBar').classList.toggle('hidden', tab !== 'elements');
    this.renderLeftContent();
  },

  switchRightTab: function(tab, btn) {
    this.rightTab = tab;
    btn.parentElement.querySelectorAll('.sem-content-tab').forEach(function(t) { t.classList.remove('active'); });
    btn.classList.add('active');
    this.renderRightContent();
  },

  renderLeftContent: function() {
    var area = document.getElementById('semLeftContent');
    if (this.leftTab === 'markdown') {
      if (!this.rawMarkdown) {
        area.innerHTML = '<div class="placeholder-text">Enter a URL and click Analyze to start</div>';
      } else {
        area.innerHTML = '<div class="markdown-body">' + safeMd(this.rawMarkdown) + '</div>';
      }
    } else {
      this.renderElements(area);
    }
  },

  renderRightContent: function() {
    var area = document.getElementById('semRightContent');
    if (this.rightTab === 'screenshot') {
      if (this.screenshotHtml) {
        area.className = 'sem-right-area screenshot-mode';
        area.innerHTML = this.screenshotHtml;
      } else {
        area.className = 'sem-right-area';
        area.innerHTML = '<div class="placeholder-text">Waiting for screenshot...</div>';
      }
    } else {
      area.className = 'sem-right-area';
      if (this.rawMarkdown) {
        area.innerHTML = '<div class="raw-output">' + esc(this.rawMarkdown) + '</div>';
      } else {
        area.innerHTML = '<div class="placeholder-text">Waiting for analysis...</div>';
      }
    }
  },

  renderElements: function(container) {
    var elements = this.currentElements;
    var filtered = this.currentFilter === 'all' ? elements : elements.filter(function(e) { return e.type === Sem.currentFilter; });
    if (!container) container = document.getElementById('semLeftContent');

    if (filtered.length === 0) {
      container.innerHTML = '<div class="placeholder-text">No elements found</div>';
      return;
    }

    container.innerHTML = '<div class="element-list">' + filtered.map(function(el) {
      var label = el.label || '(no label)';
      var actions = el.actions || ['click'];
      var safeId = esc(el.id).replace(/'/g, '&#39;');
      var actionBtns = actions.map(function(a) {
        if (a === 'click') return '<button class="btn-action btn-click" data-sem-action="click" data-sem-id="' + safeId + '">Click</button>';
        if (a === 'type') return '<button class="btn-action btn-type" data-sem-action="type" data-sem-id="' + safeId + '">Type</button>';
        return '';
      }).join('');

      return '<div class="element-item">' +
        '<div class="element-info">' +
        '<span class="element-type ' + el.type + '">' + el.type + '</span>' +
        '<span class="element-label">' + esc(label) + '</span>' +
        '<div class="element-id">' + esc(el.id) + '</div>' +
        '</div>' +
        '<div class="element-actions">' + actionBtns + '</div>' +
        '</div>';
    }).join('') + '</div>';
  },

  renderFilterBar: function() {
    var elements = this.currentElements;
    var types = [];
    var seen = {};
    elements.forEach(function(e) { if (!seen[e.type]) { seen[e.type] = true; types.push(e.type); } });
    var bar = document.getElementById('semFilterBar');
    bar.classList.remove('hidden');
    bar.innerHTML = '<button class="filter-btn ' + (this.currentFilter === 'all' ? 'active' : '') + '" data-filter="all">All (' + elements.length + ')</button>' +
      types.map(function(t) {
        var count = elements.filter(function(e) { return e.type === t; }).length;
        return '<button class="filter-btn ' + (Sem.currentFilter === t ? 'active' : '') + '" data-filter="' + esc(t) + '">' + esc(t) + ' (' + count + ')</button>';
      }).join('');
  },

  setFilter: function(type) {
    this.currentFilter = type;
    this.renderFilterBar();
    if (this.leftTab === 'elements') this.renderLeftContent();
  },

  showStats: function(semData) {
    var elements = semData.elements || [];
    var typeCount = {};
    elements.forEach(function(el) { typeCount[el.type] = (typeCount[el.type] || 0) + 1; });

    var bar = document.getElementById('semStatsBar');
    bar.classList.remove('hidden');
    bar.innerHTML =
      '<div class="stat-item"><span class="stat-val">' + elements.length + '</span> elements</div>' +
      '<div class="stat-item"><span class="stat-val">' + (typeCount.button || 0) + '</span> buttons</div>' +
      '<div class="stat-item"><span class="stat-val">' + (typeCount.link || 0) + '</span> links</div>' +
      '<div class="stat-item"><span class="stat-val">' + (typeCount.textbox || 0) + '</span> inputs</div>' +
      '<div class="stat-item"><span class="stat-val">' + (semData.regions || []).length + '</span> regions</div>';
  },

  updateCurrentPage: function(url, title) {
    var container = document.getElementById('semCurrentPage');
    var urlEl = document.getElementById('semCurrentUrl');
    var titleEl = document.getElementById('semCurrentTitle');
    container.classList.remove('hidden');
    urlEl.href = url;
    urlEl.textContent = url;
    titleEl.textContent = title ? '- ' + title : '';
  },

  refreshScreenshot: function() {
    if (!this.sessionId) return;
    var self = this;
    fetch('/v1/sessions/' + this.sessionId + '/screenshot')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.image) {
          if (data.image && data.image.indexOf('data:image/') === 0) {
            var _simg = document.createElement('img');
            _simg.src = data.image;
            _simg.alt = 'screenshot';
            self.screenshotHtml = _simg.outerHTML;
          }
          if (self.rightTab === 'screenshot') self.renderRightContent();
        }
      }).catch(function() {});
  },

  doAction: function(action, elementId, value) {
    var self = this;
    self.addLog('Executing ' + action + ': ' + elementId, 'info');
    fetch('/v1/sessions/' + self.sessionId + '/action', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: action, elementId: elementId, value: value })
    }).then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        self.addLog('Success! Page: ' + (data.page?.title || '-'), 'success');
        self.updateCurrentPage(data.page?.url || '', data.page?.title || '');
        setTimeout(function() { self.refreshElements(); }, 800);
      } else {
        self.addLog('Failed: ' + (data.error?.message || 'Unknown error'), 'error');
      }
    }).catch(function(err) {
      self.addLog('Network error: ' + err.message, 'error');
    });
  },

  showTypeModal: function(elementId) {
    this.pendingTypeElementId = elementId;
    document.getElementById('typeModal').classList.remove('hidden');
    document.getElementById('typeValue').focus();
  },

  closeTypeModal: function() {
    document.getElementById('typeModal').classList.add('hidden');
    document.getElementById('typeValue').value = '';
    this.pendingTypeElementId = null;
  },

  confirmType: function() {
    var value = document.getElementById('typeValue').value;
    if (this.pendingTypeElementId && value) {
      this.doAction('type', this.pendingTypeElementId, value);
    }
    this.closeTypeModal();
  },

  refreshElements: function() {
    var self = this;
    self.showStatus('Refreshing elements...', 'loading');
    fetch('/v1/sessions/' + self.sessionId + '/semantic')
      .then(function(r) { return r.json(); })
      .then(function(semData) {
        self.currentElements = semData.elements || [];
        self.renderFilterBar();
        if (self.leftTab === 'elements') self.renderLeftContent();
        self.showStats(semData);
        self.updateCurrentPage(semData.page?.url || '', semData.page?.title || '');
        self.refreshScreenshot();
        self.showStatus('Refreshed: ' + (semData.page?.title || '-'), 'success');
      }).catch(function(err) {
        self.showStatus('Refresh failed: ' + err.message, 'error');
      });
  },

  closeSession: function() {
    var self = this;
    if (!self.sessionId) return;
    fetch('/v1/sessions/' + self.sessionId, { method: 'DELETE' })
      .then(function() {
        self.sessionId = null;
        self.currentElements = [];
        self.rawMarkdown = '';
        self.screenshotHtml = '';
        document.getElementById('semStatsBar').classList.add('hidden');
        document.getElementById('semCurrentPage').classList.add('hidden');
        document.getElementById('semFilterBar').classList.add('hidden');
        document.getElementById('semRefreshBtn').style.display = 'none';
        document.getElementById('semSendToAgent').style.display = 'none';
        self.renderLeftContent();
        self.renderRightContent();
        self.showStatus('Session closed', 'success');
        updateHeaderButtons();
      });
  },

  analyze: function() {
    var self = this;
    var url = document.getElementById('semUrlInput').value.trim();
    if (!url) { self.showStatus('Please enter a URL', 'error'); return; }

    var btn = document.getElementById('semAnalyzeBtn');
    btn.disabled = true;
    btn.textContent = 'Analyzing...';

    // Close old session
    var closePromise = self.sessionId
      ? fetch('/v1/sessions/' + self.sessionId, { method: 'DELETE' })
      : Promise.resolve();

    closePromise.then(function() {
      self.showStatus('Creating browser session...', 'loading');
      var settings = loadSettings();
      var sessionOpts = {};
      if (settings.headless === false) sessionOpts.headless = false;
      return fetch('/v1/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sessionOpts)
      });
    }).then(function(r) {
      if (!r.ok) throw new Error('Failed to create session: ' + r.status);
      return r.json();
    })
    .then(function(sessionData) {
      self.sessionId = sessionData.sessionId;
      self.showStatus('Navigating to target...', 'loading');
      return fetch('/v1/sessions/' + self.sessionId + '/navigate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: url })
      });
    }).then(function(r) { return r.json(); })
    .then(function(navData) {
      if (!navData.success) throw new Error(navData.error?.message || 'Navigation failed');
      self.showStatus('Extracting semantic elements...', 'loading');
      return Promise.all([
        fetch('/v1/sessions/' + self.sessionId + '/semantic').then(function(r) { return r.json(); }),
        fetch('/v1/sessions/' + self.sessionId + '/content').then(function(r) { return r.json(); })
      ]);
    }).then(function(results) {
      var semData = results[0];
      var contentData = results[1];

      self.currentElements = semData.elements || [];
      self.renderFilterBar();
      self.showStats(semData);
      self.updateCurrentPage(semData.page?.url || url, semData.page?.title || '');

      self.rawMarkdown = self.generateMarkdown(url, semData, contentData);
      self.renderLeftContent();
      self.renderRightContent();
      self.refreshScreenshot();

      document.getElementById('semRefreshBtn').style.display = 'inline-block';
      document.getElementById('semSendToAgent').style.display = 'inline-block';
      updateHeaderButtons();

      self.showStatus('Analysis complete!', 'success');
      self.addLog('Loaded ' + (semData.elements?.length || 0) + ' elements', 'success');
    }).catch(function(err) {
      self.showStatus('Error: ' + err.message, 'error');
    }).finally(function() {
      btn.disabled = false;
      btn.textContent = 'Analyze';
    });
  },

  generateMarkdown: function(url, semData, contentData) {
    var lines = [];
    lines.push('# AI Browser Semantic Analysis\n');
    lines.push('> Time: ' + new Date().toLocaleString() + '\n');

    lines.push('## Page Info\n');
    lines.push('| Property | Value |');
    lines.push('|----------|-------|');
    lines.push('| URL | ' + (semData.page?.url || url) + ' |');
    lines.push('| Title | ' + (semData.page?.title || '-') + ' |');
    lines.push('| Type | `' + (semData.page?.type || 'unknown') + '` |');
    lines.push('| Summary | ' + (semData.page?.summary || '-') + ' |');
    lines.push('');

    var elements = semData.elements || [];
    var typeCount = {};
    elements.forEach(function(el) { typeCount[el.type] = (typeCount[el.type] || 0) + 1; });

    lines.push('## Element Stats\n');
    lines.push('Total **' + elements.length + '** interactive elements:\n');
    lines.push('| Type | Count |');
    lines.push('|------|-------|');
    Object.keys(typeCount).forEach(function(type) {
      lines.push('| ' + type + ' | ' + typeCount[type] + ' |');
    });
    lines.push('');

    lines.push('## Elements (first 20)\n');
    elements.slice(0, 20).forEach(function(el, i) {
      var label = el.label || '(no label)';
      var actions = el.actions?.join(', ') || '-';
      lines.push((i + 1) + '. **[' + el.type + ']** ' + label);
      lines.push('   - ID: `' + el.id + '`');
      lines.push('   - Actions: ' + actions);
      if (el.bounds && el.bounds.width > 0) {
        lines.push('   - Position: (' + Math.round(el.bounds.x) + ', ' + Math.round(el.bounds.y) + ') ' + Math.round(el.bounds.width) + 'x' + Math.round(el.bounds.height));
      }
      lines.push('');
    });

    var regions = semData.regions || [];
    if (regions.length > 0) {
      lines.push('## Page Regions\n');
      regions.forEach(function(region) {
        lines.push('- **' + region.name + '**: ' + (region.role || '-'));
      });
      lines.push('');
    }

    if (contentData) {
      lines.push('## Content Summary\n');
      if (contentData.title) lines.push('**Title**: ' + contentData.title + '\n');
      if (contentData.text) {
        var text = contentData.text.slice(0, 500).replace(/\n+/g, ' ').trim();
        lines.push('**Preview**: ' + text + (contentData.text.length > 500 ? '...' : '') + '\n');
      }
      if (contentData.links?.length > 0) lines.push('**Links**: ' + contentData.links.length + '\n');
    }

    lines.push('## JSON Sample\n');
    lines.push('```json');
    lines.push(JSON.stringify(elements.slice(0, 3), null, 2));
    lines.push('```\n');

    return lines.join('\n');
  }
};
</script>

<script>
// ========== Agent View ==========
var Agent = {
  agentId: null,
  sessionId: null,
  eventSource: null,
  previewMode: 'markdown',
  mdHistory: [],
  MAX_HISTORY: 10,
  currentMdContent: null,
  latestScreenshotHtml: '',
  conversationHistory: [],
  currentTask: '',

  switchPreview: function(mode) {
    this.previewMode = mode;
    document.getElementById('agentTabMd').classList.toggle('active', mode === 'markdown');
    document.getElementById('agentTabSs').classList.toggle('active', mode === 'screenshot');
    this.renderPreview();
  },

  renderPreview: function() {
    var body = document.getElementById('previewBody');
    if (this.previewMode === 'screenshot') {
      body.className = 'preview-body screenshot-mode';
      body.innerHTML = this.latestScreenshotHtml || '<div class="placeholder-text">Waiting for screenshot...</div>';
    } else {
      body.className = 'preview-body';
      this.renderMarkdownPreview(body);
    }
  },

  renderMarkdownPreview: function(container) {
    if (!this.currentMdContent && this.mdHistory.length === 0) {
      container.innerHTML = '<div class="placeholder-text">Waiting for Agent output...</div>';
      return;
    }
    var html = '';
    if (this.currentMdContent) {
      html += '<div class="md-current"><div class="markdown-body">' + safeMd(this.currentMdContent.content) + '</div></div>';
    }
    if (this.mdHistory.length > 0) {
      html += '<div class="md-history"><div style="color:var(--text-muted);font-size:11px;margin-bottom:6px;">History (' + this.mdHistory.length + ')</div>';
      for (var i = this.mdHistory.length - 1; i >= 0; i--) {
        var item = this.mdHistory[i];
        var id = 'hist_' + i;
        html += '<div class="md-history-item"><button class="md-history-toggle" onclick="Agent.toggleHistory(\'' + id + '\', this)"><span class="arrow">&#9654;</span> <span>' + esc(item.label) + '</span></button><div class="md-history-content" id="' + id + '"><div class="markdown-body">' + safeMd(item.content) + '</div></div></div>';
      }
      html += '</div>';
    }
    container.innerHTML = html;
  },

  toggleHistory: function(id, btn) {
    document.getElementById(id).classList.toggle('open');
    btn.classList.toggle('open');
  },

  pushMdContent: function(label, content) {
    if (this.currentMdContent) {
      this.mdHistory.push(this.currentMdContent);
      if (this.mdHistory.length > this.MAX_HISTORY) this.mdHistory.shift();
    }
    this.currentMdContent = { label: label, content: content };
    if (this.previewMode === 'markdown') this.renderPreview();
  },

  _generation: 0,
  _resultCounter: 0,

  // ===== Agent lifecycle =====
  start: function() {
    var self = this;
    var task = document.getElementById('taskInput').value.trim();
    if (!task) return;

    self._generation++;
    var gen = self._generation;
    var settings = loadSettings();

    // Reset right panel
    self.currentMdContent = null;
    self.mdHistory = [];
    self.latestScreenshotHtml = '';
    document.getElementById('previewUrl').textContent = '';
    self.renderPreview();

    // Remove placeholder / empty state
    var ph = document.getElementById('chatMessages').querySelector('.placeholder-text') || document.getElementById('agentEmptyState');
    if (ph) ph.remove();

    document.getElementById('sendBtn').disabled = true;
    document.getElementById('btnStop').style.display = 'inline-block';
    document.getElementById('taskInput').value = '';

    self.addMsg('user', task);
    self.currentTask = task;
    self.showTyping(true);

    var body = { task: task };
    if (settings.apiKey) body.apiKey = settings.apiKey;
    if (settings.baseURL) body.baseURL = settings.baseURL;
    if (settings.model) body.model = settings.model;
    if (settings.maxIterations) body.maxIterations = settings.maxIterations;
    if (settings.timeout && settings.timeout > 0) body.timeout = settings.timeout;
    if (settings.headless === false) body.headless = false;
    if (self.conversationHistory.length > 0) body.messages = self.conversationHistory;

    fetch('/v1/agent/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    }).then(function(r) { return r.json(); })
    .then(function(data) {
      if (gen !== self._generation) return; // stale request after stop
      if (!data.agentId) throw new Error(data.error?.message || 'Failed to start agent');
      self.agentId = data.agentId;
      updateHeaderButtons();
      self.connectSSE(data.agentId);
    }).catch(function(err) {
      if (gen !== self._generation) return;
      self.addMsg('error', err.message);
      self.resetUI();
    });
  },

  stop: function() {
    this._generation++;
    if (this.eventSource) { this.eventSource.close(); this.eventSource = null; }
    this.addMsg('system', 'Agent stopped');
    this.resetUI();
  },

  resetUI: function() {
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('btnStop').style.display = 'none';
    this.agentId = null;
    this.showTyping(false);
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('progressInfo').classList.remove('active');
    document.getElementById('progressFill').style.width = '0%';
    updateHeaderButtons();
  },

  clearChat: function() {
    if (this.eventSource) { this.eventSource.close(); this.eventSource = null; }
    document.getElementById('chatMessages').innerHTML = '<div class="placeholder-text">Enter a task to start</div>';
    this.currentMdContent = null;
    this.mdHistory = [];
    this.latestScreenshotHtml = '';
    this.sessionId = null;
    this.conversationHistory = [];
    this.currentTask = '';
    document.getElementById('previewUrl').textContent = '';
    document.getElementById('agentViewElements').style.display = 'none';
    this.renderPreview();
    this.resetUI();
    ChatStore.clear();
  },

  showTyping: function(show) {
    document.getElementById('typingIndicator').classList.toggle('visible', show);
  },
};
</script>

<script>
// ===== Agent SSE + Events =====
Agent.connectSSE = function(id) {
  var self = this;
  self.eventSource = new EventSource('/v1/agent/' + id + '/events');
  self.eventSource.onmessage = function(e) {
    self.handleEvent(JSON.parse(e.data));
  };
  self.eventSource.onerror = function() {
    self.eventSource.close();
    self.eventSource = null;
    if (self.agentId) {
      self.addMsg('error', 'Connection lost');
      self.resetUI();
    }
  };
};

Agent.handleEvent = function(ev) {
  var self = this;
  switch (ev.type) {
    case 'session_created':
      self.sessionId = ev.sessionId;
      App.sharedSessionId = ev.sessionId;
      self.addMsg('system', 'Session created');
      document.getElementById('agentViewElements').style.display = 'inline-block';
      self.refreshScreenshot();
      break;
    case 'thinking':
      self.showTyping(true);
      self.addMsg('thinking', ev.content, ev.iteration);
      break;
    case 'tool_call':
      self.showTyping(true);
      self.addMsg('tool_call', ev.name, ev.iteration, ev.args);
      break;
    case 'tool_result':
      self.showTyping(false);
      self.addMsg('tool_result', ev.summary, ev.iteration, ev.success, ev.name);
      self.pushMdContent('Step ' + ev.iteration + ' - ' + ev.name, self.formatMdResult(ev.name, ev.summary));
      self.refreshScreenshot();
      break;
    case 'error':
      self.showTyping(false);
      self.addMsg('error', ev.message, ev.iteration);
      break;
    case 'input_required':
      self.showTyping(false);
      self.addMsg('system', 'Agent is waiting for your input...');
      self.showInputDialog(ev.requestId, ev.question, ev.fields);
      break;
    case 'progress':
      if (ev.progress) {
        var p = ev.progress;
        document.getElementById('progressFill').style.width = p.percent + '%';
        document.getElementById('progressPhase').textContent = p.phase || '';
        document.getElementById('progressPercent').textContent = p.percent + '%';
        document.getElementById('progressSteps').textContent =
          (p.stepsRemaining != null && p.stepsRemaining > 0) ? '~' + p.stepsRemaining + ' steps left' : '';
        document.getElementById('progressBar').classList.add('active');
        document.getElementById('progressInfo').classList.add('active');
      }
      break;
    case 'memory_recall':
      self.addMsg('memory_recall', ev.domain, ev.iteration, ev.patternCount);
      break;
    case 'done':
      self.addMsg('done', ev.success ? (ev.result || 'Done') : (ev.error || 'Failed'), null, ev.success);
      var summary = 'Total steps: ' + ev.iterations;
      if (ev.tokenUsage && ev.tokenUsage.total) {
        var tu = ev.tokenUsage;
        summary += ' | Tokens: ' + tu.total.toLocaleString() + ' (in: ' + tu.input.toLocaleString() + ' / out: ' + tu.output.toLocaleString() + ')';
      }
      self.addMsg('system', summary);
      if (self.currentTask) {
        self.conversationHistory.push({ role: 'user', content: self.currentTask });
        self.conversationHistory.push({ role: 'assistant', content: ev.result || ev.error || 'Done' });
        if (self.conversationHistory.length > 20) {
          self.conversationHistory = self.conversationHistory.slice(-20);
        }
        self.currentTask = '';
      }
      self.refreshScreenshot();
      self.resetUI();
      if (self.eventSource) { self.eventSource.close(); self.eventSource = null; }
      break;
  }
};
</script>

<script>
// ===== Agent message rendering =====
Agent.addMsg = function(type, content, iteration, extra, extra2) {
  var container = document.getElementById('chatMessages');
  var ph = container.querySelector('.placeholder-text');
  if (ph) ph.remove();

  var el = document.createElement('div');
  el.className = 'msg';
  var self = this;

  switch (type) {
    case 'user':
      el.className = 'msg msg-user';
      el.innerHTML = '<div class="bubble">' + esc(content) + '</div>';
      break;
    case 'system':
      el.className = 'msg msg-system';
      el.textContent = '\u2014 ' + content + ' \u2014';
      break;
    case 'thinking':
      el.className = 'msg msg-thinking';
      el.innerHTML = this.stepTag(iteration) + '<div class="md-inline markdown-body">' + safeMd(content || '') + '</div>';
      break;
    case 'tool_call':
      el.className = 'msg msg-tool-call';
      var desc = self.humanizeToolCall(content, extra);
      el.innerHTML = self.stepTag(iteration) +
        '<div class="tool-header"><span class="tool-icon">\u25B6</span> <span class="tool-desc">' + esc(desc) + '</span></div>' +
        '<details class="tool-raw"><summary>Raw params</summary><pre>' + esc(JSON.stringify(extra, null, 2)) + '</pre></details>';
      break;
    case 'tool_result':
      el.className = 'msg msg-tool-result ' + (extra ? 'success' : 'fail');
      var lbl = extra ? 'Result' : 'Error';
      var clr = extra ? '#3fb950' : '#f85149';
      var mdContent = this.formatMdResult(extra2 || lbl, content);
      var resultId = 'result_' + (++this._resultCounter);
      el.innerHTML = this.stepTag(iteration) +
        '<span style="color:' + clr + ';font-weight:600;">' + esc(extra2 || lbl) + '</span>' +
        '<div class="result-content" id="' + resultId + '"><div class="markdown-body">' + safeMd(mdContent) + '</div></div>' +
        '<button class="expand-btn" onclick="Agent.toggleExpand(\'' + resultId + '\', this)">Show more</button>';
      // Check if needs expand after render
      setTimeout(function() {
        var rc = document.getElementById(resultId);
        if (rc && rc.scrollHeight > 130) {
          rc.classList.add('needs-expand');
          rc.nextElementSibling.classList.add('visible');
        }
      }, 50);
      break;
    case 'error':
      el.className = 'msg msg-error';
      el.innerHTML = (iteration ? this.stepTag(iteration) : '') + 'Error: ' + esc(content);
      break;
    case 'memory_recall':
      el.className = 'msg msg-memory-recall';
      el.innerHTML = this.stepTag(iteration) +
        '<div class="memory-recall-hint">' +
        '<span class="memory-icon">🧠</span> ' +
        '<span>Recalled site memory for <strong>' + esc(content) + '</strong> (' + (extra || 0) + ' patterns)</span>' +
        '</div>';
      break;
    case 'done':
      el.className = 'msg msg-done ' + (extra ? 'success' : 'fail');
      var title = extra ? 'Task Completed' : 'Task Failed';
      var tc = extra ? '#3fb950' : '#f85149';
      el.innerHTML = '<div class="title" style="color:' + tc + '">' + title + '</div><div class="markdown-body">' + safeMd(content || '') + '</div>';
      break;
  }

  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
  ChatStore.save();
};

Agent.toggleExpand = function(id, btn) {
  var el = document.getElementById(id);
  var expanded = el.classList.toggle('expanded');
  btn.textContent = expanded ? 'Show less' : 'Show more';
};

Agent.stepTag = function(n) {
  if (n == null) return '';
  return '<span class="step-tag">Step ' + n + '</span>';
};

Agent.humanizeToolCall = function(name, args) {
  args = args || {};
  var map = {
    navigate: function(a) { return 'Navigate: ' + (a.url || ''); },
    click: function(a) { return 'Click: ' + (a.elementId || a.element_id || ''); },
    type_text: function(a) { return 'Type: "' + (a.text || '').slice(0, 40) + '"'; },
    get_page_info: function() { return 'Get page elements'; },
    get_page_content: function() { return 'Extract page content'; },
    find_element: function(a) { return 'Search: "' + (a.query || '') + '"'; },
    screenshot: function() { return 'Take screenshot'; },
    scroll: function(a) { return 'Scroll ' + (a.direction || 'down'); },
    press_key: function(a) { return 'Press key: ' + (a.key || ''); },
    select_option: function(a) { return 'Select: ' + (a.value || a.text || ''); },
    fill_form: function(a) { return 'Fill form (' + (a.fields ? a.fields.length : 0) + ' fields)'; },
    click_and_wait: function(a) { return 'Click & wait: ' + (a.element_id || ''); },
    navigate_and_extract: function(a) { return 'Navigate & extract: ' + (a.url || ''); },
    hover: function(a) { return 'Hover: ' + (a.elementId || a.element_id || ''); },
    go_back: function() { return 'Go back'; },
    wait: function(a) { return 'Wait: ' + (a.condition || (a.ms + 'ms')); },
    wait_for_stable: function() { return 'Wait for page stable'; },
    done: function(a) { return 'Done: ' + (a.result || '').slice(0, 50); },
    set_value: function(a) { return 'Set value: ' + (a.elementId || a.element_id || ''); },
    upload_file: function() { return 'Upload file'; },
    execute_javascript: function() { return 'Execute JavaScript'; },
    create_tab: function() { return 'Create new tab'; },
    list_tabs: function() { return 'List tabs'; },
    switch_tab: function(a) { return 'Switch to tab ' + (a.tabId || ''); },
    close_tab: function() { return 'Close tab'; },
  };
  var fn = map[name];
  return fn ? fn(args) : name;
};
</script>

<script>
// ===== Agent formatMdResult + screenshot + input dialog =====
Agent.formatMdResult = function(toolName, summary) {
  try {
    var obj = JSON.parse(summary);
    // Priority 1: use aiMarkdown from backend MCP enrichment layer
    if (typeof obj.aiMarkdown === 'string' && obj.aiMarkdown.length > 0) {
      return '## ' + toolName + '\n\n' + obj.aiMarkdown;
    }
    // Priority 2: use aiSummary as fallback
    if (typeof obj.aiSummary === 'string' && obj.aiSummary.length > 0) {
      return '## ' + toolName + '\n\n' + obj.aiSummary;
    }
    // Priority 3: manual formatting for tools without aiMarkdown
    if (toolName === 'get_page_info' && obj.elements) {
      var md = '## Page: ' + (obj.page?.title || '') + '\n\n';
      md += '**URL:** ' + (obj.page?.url || '') + '\n\n';
      md += '**Elements:** ' + obj.elementCount + '\n\n';
      md += '| ID | Type | Label |\n|---|---|---|\n';
      (obj.elements || []).forEach(function(el) {
        md += '| `' + el.id + '` | ' + el.type + ' | ' + (el.label || '-') + ' |\n';
      });
      return md;
    }
    if (toolName === 'navigate' && obj.page) {
      return '## Navigate\n\n**URL:** ' + (obj.page?.url || '') + '\n\n**Title:** ' + (obj.page?.title || '');
    }
    // Fallback: compact JSON
    return '## ' + toolName + '\n\n```json\n' + JSON.stringify(obj, null, 2) + '\n```';
  } catch (e) {
    return '## ' + toolName + '\n\n```\n' + summary + '\n```';
  }
};

Agent.refreshScreenshot = function() {
  var self = this;
  if (!self.sessionId) return;
  var body = document.getElementById('previewBody');
  if (self.previewMode === 'screenshot') body.classList.add('screenshot-loading');
  fetch('/v1/sessions/' + self.sessionId + '/screenshot')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.image && data.image.indexOf('data:image/') === 0) {
        var _img = document.createElement('img');
        _img.src = data.image;
        _img.alt = 'screenshot';
        self.latestScreenshotHtml = _img.outerHTML;
      }
      return fetch('/v1/sessions/' + self.sessionId);
    }).then(function(r) { return r.json(); })
    .then(function(info) {
      if (info.tabs && info.tabs.length > 0) {
        var tab = info.tabs.find(function(t) { return t.id === info.activeTabId; }) || info.tabs[0];
        document.getElementById('previewUrl').textContent = tab.url || '';
      }
      body.classList.remove('screenshot-loading');
      if (self.previewMode === 'screenshot') {
        self.renderPreview();
        body.classList.add('screenshot-updated');
        setTimeout(function() { body.classList.remove('screenshot-updated'); }, 400);
      }
    }).catch(function() { body.classList.remove('screenshot-loading'); });
};
</script>

<script>
// ===== Agent input dialog (ask_human) =====
Agent.showInputDialog = function(requestId, question, fields) {
  var existing = document.getElementById('inputModal');
  if (existing) existing.remove();

  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'inputModal';

  var modal = document.createElement('div');
  modal.className = 'modal';

  var h2 = document.createElement('h2');
  h2.textContent = question;
  modal.appendChild(h2);

  fields.forEach(function(field) {
    var label = document.createElement('label');
    label.textContent = field.label;
    modal.appendChild(label);

    var input = document.createElement('input');
    input.type = field.type || 'text';
    input.id = 'input_field_' + field.name;
    input.setAttribute('data-field-name', field.name);
    input.setAttribute('data-field-type', field.type);
    input.placeholder = field.label;
    modal.appendChild(input);
  });

  var btns = document.createElement('div');
  btns.className = 'modal-btns';

  var cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.onclick = function() { Agent.cancelInput(requestId); };
  btns.appendChild(cancelBtn);

  var submitBtn = document.createElement('button');
  submitBtn.className = 'btn btn-save';
  submitBtn.textContent = 'Submit';
  submitBtn.onclick = function() { Agent.submitInput(requestId); };
  btns.appendChild(submitBtn);

  modal.appendChild(btns);
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
};

Agent.submitInput = function(requestId) {
  var modal = document.getElementById('inputModal');
  if (!modal) return;
  var btns = modal.querySelectorAll('button');
  btns.forEach(function(b) { b.disabled = true; });

  var inputs = modal.querySelectorAll('input[data-field-name]');
  var response = {};
  var displayParts = [];
  inputs.forEach(function(input) {
    var name = input.getAttribute('data-field-name');
    var type = input.getAttribute('data-field-type');
    response[name] = input.value;
    displayParts.push(name + ': ' + (type === 'password' ? '***' : input.value));
  });

  var self = this;
  fetch('/v1/agent/' + self.agentId + '/input', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ requestId: requestId, response: response }),
  }).then(function() {
    self.addMsg('system', 'Submitted: ' + displayParts.join(', '));
    modal.remove();
  }).catch(function(err) {
    self.addMsg('error', 'Submit failed: ' + err.message);
    btns.forEach(function(b) { b.disabled = false; });
  });
};

Agent.cancelInput = function(requestId) {
  var modal = document.getElementById('inputModal');
  if (!modal) return;
  var self = this;
  fetch('/v1/agent/' + self.agentId + '/input', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ requestId: requestId, response: { error: 'User cancelled input' } }),
  }).catch(function() {});
  self.addMsg('system', 'Input cancelled');
  modal.remove();
};
</script>

<script>
// ===== ChatStore: localStorage persistence =====
var CHAT_STORE_KEY = 'ai_browser_chat_history';
var ChatStore = {
  _saveTimer: null,
  save: function() {
    if (ChatStore._saveTimer) clearTimeout(ChatStore._saveTimer);
    ChatStore._saveTimer = setTimeout(ChatStore._doSave, 500);
  },
  _doSave: function() {
    ChatStore._saveTimer = null;
    try {
      var msgs = [];
      var container = document.getElementById('chatMessages');
      container.querySelectorAll('.msg').forEach(function(el) {
        var type = '';
        if (el.classList.contains('msg-user')) type = 'user';
        else if (el.classList.contains('msg-system')) type = 'system';
        else if (el.classList.contains('msg-thinking')) type = 'thinking';
        else if (el.classList.contains('msg-tool-call')) type = 'tool_call';
        else if (el.classList.contains('msg-tool-result')) type = 'tool_result';
        else if (el.classList.contains('msg-error')) type = 'error';
        else if (el.classList.contains('msg-done')) type = 'done';
        if (type) msgs.push({ type: type, html: el.outerHTML });
      });
      if (msgs.length === 0) return;
      if (msgs.length > 50) msgs = msgs.slice(-50);
      var data = {
        messages: msgs,
        conversationHistory: Agent.conversationHistory,
        savedAt: Date.now()
      };
      localStorage.setItem(CHAT_STORE_KEY, JSON.stringify(data));
    } catch(e) { /* quota exceeded or other error */ }
  },
  load: function() {
    try {
      var raw = localStorage.getItem(CHAT_STORE_KEY);
      if (!raw) return;
      var data = JSON.parse(raw);
      if (!data.messages || data.messages.length === 0) return;
      var container = document.getElementById('chatMessages');
      var ph = container.querySelector('.placeholder-text');
      if (ph) ph.remove();
      data.messages.forEach(function(m) {
        var wrapper = document.createElement('div');
        wrapper.innerHTML = DOMPurify.sanitize(m.html);
        if (wrapper.firstChild) container.appendChild(wrapper.firstChild);
      });
      if (data.conversationHistory) {
        Agent.conversationHistory = data.conversationHistory;
      }
    } catch(e) { /* parse error */ }
  },
  clear: function() {
    localStorage.removeItem(CHAT_STORE_KEY);
  }
};
</script>

<script>
// ===== Tasks: SPA integration =====
var Tasks = {
  pollTimer: null,
  currentTaskId: null,

  refreshList: function() {
    var list = document.getElementById('tasksList');
    list.innerHTML = '<div class="placeholder-text">Loading...</div>';
    document.getElementById('taskDetail').style.display = 'none';
    document.getElementById('taskCreate').style.display = 'none';
    fetch('/v1/tasks').then(function(r) { return r.json(); }).then(function(data) {
      var tasks = data.tasks || [];
      if (tasks.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="es-icon">&#128203;</div><div class="es-title">No Tasks Yet</div><div class="es-desc">Click <strong>+ New Task</strong> above to create a deterministic task template. Tasks are repeatable browser automations that run the same steps every time.</div><div class="es-steps"><div><span class="step-num">1</span>Click <strong>+ New Task</strong> to create a template</div><div><span class="step-num">2</span>Set a URL, goal, and optional parameters</div><div><span class="step-num">3</span>Run the task and view results with artifacts</div></div></div>';
        return;
      }
      list.innerHTML = '';
      tasks.forEach(function(t) {
        var card = document.createElement('div');
        card.className = 'task-card';
        card.onclick = function() { Tasks.showResult(t.taskId); };
        var safeStatus = ['running','done','pending','failed'].indexOf(t.status) >= 0 ? t.status : 'pending';
        var statusCls = 'task-status ' + safeStatus;
        card.innerHTML = '<div class="' + statusCls + '">' + esc(t.status || 'unknown') + '</div>' +
          '<div style="font-weight:500;margin:6px 0">' + esc((t.goal || '').slice(0, 80)) + '</div>' +
          '<div style="font-size:12px;color:var(--text-muted)">' + new Date(t.createdAt).toLocaleString() + '</div>';
        list.appendChild(card);
      });
    }).catch(function() {
      list.innerHTML = '<div class="placeholder-text">Failed to load tasks.</div>';
    });
  },

  showCreate: function() {
    document.getElementById('tasksList').style.display = 'none';
    document.getElementById('taskDetail').style.display = 'none';
    var panel = document.getElementById('taskCreate');
    panel.style.display = 'block';
    panel.innerHTML =
      '<h3 style="margin:0 0 16px">New Task</h3>' +
      '<div class="task-create-form">' +
        '<label>Goal</label>' +
        '<textarea id="tcGoal" rows="3" placeholder="Describe what you want the agent to do..."></textarea>' +
        '<label>Start URL (optional)</label>' +
        '<input type="text" id="tcUrl" placeholder="https://...">' +
        '<label>Max Steps</label>' +
        '<input type="number" id="tcMaxSteps" value="20" min="1" max="200">' +
        '<div style="display:flex;gap:8px;margin-top:12px">' +
          '<button class="btn btn-primary" onclick="Tasks.submitTask()">Run Task</button>' +
          '<button class="btn" onclick="Tasks.backToList()">Cancel</button>' +
        '</div>' +
      '</div>';
  },

  backToList: function() {
    document.getElementById('taskCreate').style.display = 'none';
    document.getElementById('taskDetail').style.display = 'none';
    document.getElementById('tasksList').style.display = '';
    Tasks.refreshList();
  },

  submitTask: function() {
    var goal = document.getElementById('tcGoal').value.trim();
    if (!goal) return;
    var url = document.getElementById('tcUrl').value.trim();
    var maxSteps = parseInt(document.getElementById('tcMaxSteps').value) || 20;
    if (url) goal = goal + '\nStart URL: ' + url;

    var cfg = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
    var body = {
      goal: goal,
      maxIterations: maxSteps,
      apiKey: cfg.apiKey || undefined,
      baseURL: cfg.baseURL || undefined,
      model: cfg.model || undefined,
      headless: cfg.headless !== undefined ? cfg.headless : true,
    };

    fetch('/v1/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    }).then(function(r) { return r.json(); }).then(function(data) {
      if (data.taskId) {
        Tasks.showResult(data.taskId);
      } else {
        alert('Failed to create task: ' + JSON.stringify(data));
      }
    }).catch(function(err) {
      alert('Error: ' + err.message);
    });
  },

  showResult: function(taskId) {
    Tasks.currentTaskId = taskId;
    document.getElementById('tasksList').style.display = 'none';
    document.getElementById('taskCreate').style.display = 'none';
    var panel = document.getElementById('taskDetail');
    panel.style.display = 'block';
    panel.innerHTML = '<div class="placeholder-text">Loading task...</div>';

    fetch('/v1/tasks/' + taskId).then(function(r) { return r.json(); }).then(function(data) {
      var safeStatus = ['running','done','pending','failed'].indexOf(data.status) >= 0 ? data.status : 'pending';
      var statusCls = 'task-status ' + safeStatus;
      var html = '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">' +
        '<button class="btn" onclick="Tasks.backToList()">&larr; Back</button>' +
        '<span class="' + statusCls + '">' + esc(data.status || '') + '</span>' +
        '<span style="font-size:12px;color:var(--text-muted)">' + esc(taskId.slice(0, 8)) + '</span>' +
      '</div>';
      html += '<div style="margin-bottom:12px"><strong>Goal:</strong> ' + esc(data.goal || '(unknown)') + '</div>';
      if (data.result) {
        html += '<div style="margin-bottom:12px"><strong>Result:</strong></div>' +
          '<pre style="background:var(--bg-secondary);padding:12px;border-radius:6px;overflow:auto;max-height:300px">' +
          esc(typeof data.result === 'string' ? data.result : JSON.stringify(data.result, null, 2)) + '</pre>';
      }
      if (data.error) {
        html += '<div style="color:var(--danger)"><strong>Error:</strong> ' + esc(data.error) + '</div>';
      }
      html += '<div id="taskEvents" style="margin-top:16px"></div>';
      panel.innerHTML = html;

      if (data.status === 'running') {
        Tasks.pollStatus(taskId);
      }
    }).catch(function() {
      panel.innerHTML = '<div class="placeholder-text">Failed to load task.</div>' +
        '<button class="btn" onclick="Tasks.backToList()" style="margin-top:12px">&larr; Back</button>';
    });
  },

  pollStatus: function(taskId) {
    if (Tasks.pollTimer) clearInterval(Tasks.pollTimer);
    Tasks.pollTimer = setInterval(function() {
      if (Tasks.currentTaskId !== taskId) {
        clearInterval(Tasks.pollTimer);
        Tasks.pollTimer = null;
        return;
      }
      fetch('/v1/tasks/' + taskId).then(function(r) { return r.json(); }).then(function(data) {
        if (data.status !== 'running') {
          clearInterval(Tasks.pollTimer);
          Tasks.pollTimer = null;
          Tasks.showResult(taskId);
        }
      }).catch(function() {});
    }, 3000);
  }
};
</script>

<script>
// ===== Keyboard shortcuts =====
document.getElementById('taskInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && !document.getElementById('sendBtn').disabled) Agent.start();
});

document.getElementById('semUrlInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') Sem.analyze();
});

// Event delegation for semantic element action buttons (avoids XSS via inline onclick)
document.getElementById('semLeftContent').addEventListener('click', function(e) {
  var btn = e.target.closest('[data-sem-action]');
  if (!btn) return;
  var action = btn.getAttribute('data-sem-action');
  var id = btn.getAttribute('data-sem-id');
  if (action === 'click') Sem.doAction('click', id);
  else if (action === 'type') Sem.showTypeModal(id);
});

// Event delegation for filter bar buttons
document.getElementById('semFilterBar').addEventListener('click', function(e) {
  var btn = e.target.closest('[data-filter]');
  if (!btn) return;
  Sem.setFilter(btn.getAttribute('data-filter'));
});

// Enter key on type modal
document.getElementById('typeValue').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') Sem.confirmType();
});
</script>

<script>
// ===== Memory View =====
var Memory = {
  refreshList: function() {
    var list = document.getElementById('memoryList');
    list.innerHTML = '<div class="placeholder-text">Loading...</div>';
    document.getElementById('memoryDetail').style.display = 'none';
    list.style.display = '';

    fetch('/v1/memory').then(function(r) { return r.json(); }).then(function(data) {
      var entries = data.entries || [];
      if (entries.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="es-icon">&#129504;</div><div class="es-title">No Site Memories Yet</div><div class="es-desc">Memories are automatically learned when the agent completes tasks, or you can manually record browsing sessions in the <strong>Record</strong> tab. Each memory card stores selectors, navigation paths, and interaction patterns for a domain.</div><div class="es-examples"><span class="es-example" onclick="switchView(\'record\')">Go to Record tab</span><span class="es-example" onclick="switchView(\'agent\')">Run an Agent task</span></div></div>';
        return;
      }
      list.innerHTML = '';
      entries.forEach(function(entry) {
        var card = document.createElement('div');
        card.className = 'memory-card';
        card.onclick = function() { Memory.showDetail(entry.domain); };

        var badges = '';
        if (entry.siteType && entry.siteType !== 'unknown') {
          badges += '<span class="site-type">' + esc(entry.siteType) + '</span>';
        }
        if (entry.requiresLogin) {
          badges += '<span class="login-badge">Login</span>';
        }

        var patterns = (entry.topPatterns || []).slice(0, 3);
        var patternHtml = patterns.map(function(p) {
          return '<span class="pattern-tag">' + esc(p) + '</span>';
        }).join('');

        var lastUsed = entry.lastUsedAt ? new Date(entry.lastUsedAt).toLocaleDateString() : '-';

        card.innerHTML =
          '<div class="memory-domain">' + esc(entry.domain) + badges + '</div>' +
          '<div class="memory-meta">' + entry.patternCount + ' patterns · Last used: ' + lastUsed + '</div>' +
          '<div class="memory-patterns">' + patternHtml + '</div>';
        list.appendChild(card);
      });
    }).catch(function() {
      list.innerHTML = '<div class="placeholder-text">Failed to load memories.</div>';
    });
  },

  showDetail: function(domain) {
    document.getElementById('memoryList').style.display = 'none';
    var panel = document.getElementById('memoryDetail');
    panel.style.display = 'block';
    panel.innerHTML = '<div class="placeholder-text">Loading...</div>';

    fetch('/v1/memory/' + encodeURIComponent(domain)).then(function(r) { return r.json(); }).then(function(card) {
      var siteTag = card.siteType && card.siteType !== 'unknown' ? ' [' + card.siteType.toUpperCase() + ']' : '';
      var html = '<div class="memory-detail-header">' +
        '<button class="btn" onclick="Memory.backToList()">&larr; Back</button>' +
        '<span style="font-size:16px;font-weight:600">' + esc(card.domain) + esc(siteTag) + '</span>' +
        '<span style="font-size:12px;color:var(--text-muted)">v' + card.version + '</span>' +
        '<button class="btn btn-danger" style="margin-left:auto" onclick="Memory.deleteDomain(\'' + esc(card.domain).replace(/'/g, '&#39;') + '\')">Delete</button>' +
        '</div>';

      html += '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">' +
        'Created: ' + new Date(card.createdAt).toLocaleString() +
        ' · Updated: ' + new Date(card.updatedAt).toLocaleString() +
        (card.requiresLogin ? ' · <span style="color:var(--orange)">Requires Login</span>' : '') +
        '</div>';

      html += '<div class="pattern-list">';
      (card.patterns || []).forEach(function(p) {
        var now = Date.now();
        var daysSince = (now - p.lastUsedAt) / 86400000;
        var effConf = (p.confidence * Math.pow(0.95, daysSince)).toFixed(2);

        html += '<div class="pattern-item">' +
          '<span class="pattern-type ' + esc(p.type) + '">' + esc(p.type) + '</span>' +
          '<span style="font-size:11px;color:var(--text-muted)">' + esc(p.source || '') + '</span>' +
          '<div class="pattern-desc">' + esc(p.description) + '</div>' +
          '<div class="pattern-value">' + esc(p.value) + '</div>' +
          '<div class="pattern-meta">' +
            '<span>Confidence: ' + effConf + '</span>' +
            '<span>Used: ' + p.useCount + 'x</span>' +
            '<span>Last: ' + new Date(p.lastUsedAt).toLocaleDateString() + '</span>' +
          '</div>' +
          '</div>';
      });
      html += '</div>';

      panel.innerHTML = html;
    }).catch(function() {
      panel.innerHTML = '<div class="placeholder-text">Failed to load card.</div>' +
        '<button class="btn" onclick="Memory.backToList()" style="margin-top:12px">&larr; Back</button>';
    });
  },

  backToList: function() {
    document.getElementById('memoryDetail').style.display = 'none';
    document.getElementById('memoryList').style.display = '';
    Memory.refreshList();
  },

  deleteDomain: function(domain) {
    if (!confirm('Delete all memories for ' + domain + '?')) return;
    fetch('/v1/memory/' + encodeURIComponent(domain), { method: 'DELETE' })
      .then(function() { Memory.backToList(); })
      .catch(function(err) { alert('Delete failed: ' + err.message); });
  }
};
</script>

<script>
// ========== Recording ==========
function recJsonOrThrow(r) {
  if (!r.ok) return r.text().then(function(text) {
    try {
      var body = JSON.parse(text);
      var err = body.error;
      var msg = (err && err.message) ? err.message : (body.message || ('HTTP ' + r.status));
      throw new Error(msg);
    } catch(e) {
      if (e instanceof SyntaxError) throw new Error('HTTP ' + r.status + ': ' + (text.slice(0, 200) || 'Unknown error'));
      throw e;
    }
  });
  return r.json();
}

/** Extract structural patterns from recording events (shared by renderReview and saveToMemory) */
function extractPatternsFromEvents(events) {
  var patterns = [];
  var seen = {};
  var now = Date.now();
  var navEvents = events.filter(function(e) { return e.type === 'navigate' && e.url; });
  if (navEvents.length >= 2) {
    var paths = navEvents.map(function(e) {
      try { return new URL(e.url).pathname; } catch(x) { return e.url; }
    }).join(' → ');
    if (!seen[paths]) {
      seen[paths] = true;
      patterns.push({ type: 'navigation_path', description: 'Navigation path', value: paths, confidence: 0.8, source: 'human_recording', createdAt: now, lastUsedAt: now, useCount: 0 });
    }
  }
  events.forEach(function(e) {
    if (e.type === 'click' && e.target && !seen['click:' + e.target]) {
      seen['click:' + e.target] = true;
      patterns.push({ type: 'selector', description: e.targetLabel || e.target, value: e.target, confidence: 0.8, source: 'human_recording', createdAt: now, lastUsedAt: now, useCount: 0 });
    }
    if ((e.type === 'type' || e.type === 'select') && e.target && !seen['input:' + e.target]) {
      seen['input:' + e.target] = true;
      patterns.push({ type: 'page_structure', description: e.targetLabel || e.target, value: e.target, confidence: 0.8, source: 'human_recording', createdAt: now, lastUsedAt: now, useCount: 0 });
    }
  });
  return patterns;
}

var Rec = {
  state: 'setup',
  sessionId: null,
  startTime: null,
  timers: {},
  lastEventCount: 0,
  events: [],
  _pollFailCount: 0,
  _pollAbort: null,       // AbortController for in-flight poll requests
  _stopping: false,       // guard against double-click on stop
  _reviewData: null,      // stored stop response for saveToMemory
  _summarizeAbort: null,  // AbortController for in-flight LLM summarization
  _saving: false,         // guard against double-click on save

  setState: function(s) {
    this.state = s;
    document.getElementById('rec-setup').classList.toggle('active', s === 'setup');
    document.getElementById('rec-active').classList.toggle('active', s === 'recording');
    document.getElementById('rec-review').classList.toggle('active', s === 'review');
  },

  start: function() {
    var url = document.getElementById('recUrlInput').value.trim();
    if (!url) { alert('Please enter a URL.'); return; }
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    localStorage.setItem('rec_last_url', url);

    var btn = document.getElementById('recStartBtn');
    btn.disabled = true;
    btn.textContent = 'Starting...';
    var self = this;

    // 1. Create headful session
    fetch('/v1/sessions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ options: { headless: false } })
    })
    .then(recJsonOrThrow)
    .then(function(data) {
      self.sessionId = data.sessionId;
      // 2. Navigate
      return fetch('/v1/sessions/' + self.sessionId + '/navigate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: url })
      });
    })
    .then(recJsonOrThrow)
    .then(function() {
      // 3. Start recording
      return fetch('/v1/sessions/' + self.sessionId + '/recording/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: '{}'
      });
    })
    .then(recJsonOrThrow)
    .then(function() {
      self.startTime = Date.now();
      self.lastEventCount = 0;
      self.events = [];
      self._pollFailCount = 0;
      document.getElementById('recEventStream').innerHTML =
        '<div class="rec-empty-events"><span style="font-size:24px;opacity:0.3">&#128065;</span><span>Waiting for interactions...</span></div>';
      document.getElementById('recTimer').textContent = '00:00';
      document.getElementById('recEventCount').textContent = '0 events';
      document.getElementById('recPreviewBody').innerHTML = '<div class="skeleton"></div>';
      self.setState('recording');
      self.startPolling();
    })
    .catch(function(err) {
      alert('Failed to start recording: ' + err.message);
      if (self.sessionId) self.cleanup();
      btn.disabled = false;
      btn.textContent = 'Start Recording';
    });
  },

  stop: function() {
    if (!this.sessionId || this._stopping) return;
    this._stopping = true;
    var self = this;
    // Abort all in-flight poll requests first so the connection pool is free
    self.stopPolling();

    fetch('/v1/sessions/' + self.sessionId + '/recording/stop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ convertToMemory: false })
    })
    .then(recJsonOrThrow)
    .then(function(data) {
      self._stopping = false;
      self._reviewData = data;
      self.renderReview(data);
      self.setState('review');
      // Fire LLM summarization in background
      self.summarizeIntent(data);
    })
    .catch(function(err) {
      self._stopping = false;
      alert('Failed to stop recording: ' + err.message);
      if (self.sessionId) {
        self.setState('recording');
        self.startPolling();
      }
    });
  },

  discard: function() {
    this.stopPolling();
    if (this.state === 'recording') {
      this._stopBackendRecording();
    }
    this.cleanup();
    this.reset();
  },

  goToMemory: function() {
    this.cleanup();
    this.reset();
    switchView('memory');
  },

  summarizeIntent: function(data) {
    var recording = data.recording || {};
    var events = recording.events || [];
    var domain = data.domain || recording.domain || '';
    var textarea = document.getElementById('recIntentText');
    var hint = document.getElementById('recIntentHint');
    var saveBtn = document.getElementById('recSaveBtn');

    if (events.length === 0) {
      textarea.classList.remove('loading');
      textarea.value = '';
      textarea.placeholder = 'No events to analyze.';
      hint.textContent = '';
      return;
    }

    // Disable save while summarizing
    if (saveBtn) saveBtn.disabled = true;
    textarea.classList.add('loading');
    textarea.disabled = true;
    hint.textContent = 'AI summarizing...';

    // Abort any previous summarize request
    if (this._summarizeAbort) this._summarizeAbort.abort();
    this._summarizeAbort = new AbortController();
    var signal = this._summarizeAbort.signal;

    // Pass LLM config from user settings (same as agent endpoints)
    var settings = loadSettings();
    var payload = { events: events, domain: domain };
    if (settings.apiKey) payload.apiKey = settings.apiKey;
    if (settings.baseURL) payload.baseURL = settings.baseURL;
    if (settings.model) payload.model = settings.model;
    payload.timeout = (settings.timeout && settings.timeout > 0) ? settings.timeout : 300;

    fetch('/v1/recordings/summarize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      signal: signal
    })
    // Backend returns 200 with { intent, error? } even on LLM failure — intentional
    .then(function(r) {
      if (!r.ok) return { intent: '', error: 'Server error (' + r.status + ')' };
      return r.json();
    })
    .then(function(result) {
      textarea.classList.remove('loading');
      textarea.disabled = false;
      if (saveBtn) saveBtn.disabled = false;
      if (result.intent) {
        textarea.value = result.intent;
        hint.textContent = 'You can edit this before saving.';
      } else {
        textarea.value = '';
        textarea.placeholder = result.error || 'Could not generate summary. You can write one manually.';
        hint.textContent = result.error ? 'LLM unavailable' : '';
        if (saveBtn) saveBtn.disabled = false;
      }
    })
    .catch(function(err) {
      if (err.name === 'AbortError') return; // expected on discard/reset
      textarea.classList.remove('loading');
      textarea.disabled = false;
      if (saveBtn) saveBtn.disabled = false;
      textarea.placeholder = 'Summarization failed. You can write one manually.';
      hint.textContent = '';
    });
  },

  saveToMemory: function() {
    var data = this._reviewData;
    if (!data) { alert('No recording data.'); return; }
    if (this._saving) return;
    this._saving = true;

    var recording = data.recording || {};
    var domain = data.domain || recording.domain || '';
    if (!domain) { alert('Could not determine domain.'); return; }

    var btn = document.getElementById('recSaveBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    var self = this;

    // Build patterns from RecordingConverter (backend already computed them in stop)
    // We re-use the existing PUT /v1/memory/:domain endpoint
    // First, get the patterns that RecordingConverter would produce
    // We'll send the events to the backend to convert + add intent
    var intentText = document.getElementById('recIntentText').value.trim();
    var patterns = [];

    // Add task_intent pattern if user provided/edited intent
    if (intentText) {
      patterns.push({
        type: 'task_intent',
        description: 'Recording task intent',
        value: intentText,
        confidence: 0.9,
        source: 'human_recording'
      });
    }

    // Extract structural patterns from events (shared function)
    var events = recording.events || [];
    var structural = extractPatternsFromEvents(events);
    for (var i = 0; i < structural.length; i++) patterns.push(structural[i]);

    if (patterns.length === 0) {
      alert('No patterns or intent to save.');
      btn.disabled = false;
      btn.textContent = 'Save to Memory';
      self._saving = false;
      return;
    }

    fetch('/v1/memory/' + encodeURIComponent(domain), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ patterns: patterns })
    })
    .then(recJsonOrThrow)
    .then(function(result) {
      document.getElementById('recSuccessArea').innerHTML =
        '<div class="rec-success-msg">&#10003; Saved to memory for <strong>' + esc(domain) + '</strong> (' + result.patternCount + ' patterns)</div>';
      btn.textContent = 'Saved!';
      // Replace buttons with "View Memory" link
      document.getElementById('recActions').innerHTML =
        '<button class="btn" onclick="Rec.discard()">New Recording</button>' +
        '<button class="btn btn-primary" onclick="Rec.goToMemory()">View Memory</button>';
    })
    .catch(function(err) {
      alert('Failed to save: ' + err.message);
      btn.disabled = false;
      btn.textContent = 'Save to Memory';
      self._saving = false;
    });
  },

  reset: function() {
    this.state = 'setup';
    this.sessionId = null;
    this.startTime = null;
    this.lastEventCount = 0;
    this.events = [];
    this._pollFailCount = 0;
    this._pollAbort = null;
    this._stopping = false;
    this._reviewData = null;
    if (this._summarizeAbort) { this._summarizeAbort.abort(); this._summarizeAbort = null; }
    this._saving = false;
    this.setState('setup');
    document.getElementById('recSuccessArea').innerHTML = '';
    var btn = document.getElementById('recStartBtn');
    btn.disabled = false;
    btn.textContent = 'Start Recording';
  },

  cleanup: function() {
    if (!this.sessionId) return;
    fetch('/v1/sessions/' + this.sessionId, { method: 'DELETE' }).catch(function() {});
    this.sessionId = null;
  },

  /** Fire-and-forget stop recording on backend to clean up recorders Map */
  _stopBackendRecording: function() {
    if (!this.sessionId) return;
    fetch('/v1/sessions/' + this.sessionId + '/recording/stop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ convertToMemory: false })
    }).catch(function() {});
  },

  startPolling: function() {
    var self = this;
    this._pollAbort = new AbortController();
    this.timers.timerInterval = setInterval(function() { self.updateTimer(); }, 1000);
    this.timers.statusPoll = setInterval(function() { self.pollStatus(); }, 1000);
    this.timers.screenshotPoll = setInterval(function() { self.pollScreenshot(); }, 3000);
    // Immediate first screenshot (tracked for cleanup)
    this.timers.initialScreenshot = setTimeout(function() { self.pollScreenshot(); }, 500);
  },

  stopPolling: function() {
    if (this.timers.timerInterval) clearInterval(this.timers.timerInterval);
    if (this.timers.statusPoll) clearInterval(this.timers.statusPoll);
    if (this.timers.screenshotPoll) clearInterval(this.timers.screenshotPoll);
    if (this.timers.initialScreenshot) clearTimeout(this.timers.initialScreenshot);
    this.timers = {};
    // Abort any in-flight poll fetches immediately
    if (this._pollAbort) {
      this._pollAbort.abort();
      this._pollAbort = null;
    }
  },

  updateTimer: function() {
    if (!this.startTime) return;
    var elapsed = Math.floor((Date.now() - this.startTime) / 1000);
    var m = String(Math.floor(elapsed / 60)).padStart(2, '0');
    var s = String(elapsed % 60).padStart(2, '0');
    document.getElementById('recTimer').textContent = m + ':' + s;
  },

  pollStatus: function() {
    if (!this.sessionId || !this._pollAbort) return;
    var self = this;
    var signal = this._pollAbort.signal;
    fetch('/v1/sessions/' + this.sessionId + '/recording', { signal: signal })
      .then(recJsonOrThrow)
      .then(function(data) {
        self._pollFailCount = 0;
        var count = data.eventCount || 0;
        document.getElementById('recEventCount').textContent = count + ' event' + (count !== 1 ? 's' : '');
        if (count > self.lastEventCount) {
          var stream = document.getElementById('recEventStream');
          if (self.lastEventCount === 0) stream.innerHTML = '';
          for (var i = self.lastEventCount; i < count; i++) {
            var item = document.createElement('div');
            item.className = 'rec-event-item';
            item.innerHTML = '<span class="ev-icon">&#9679;</span>' +
              '<span class="ev-badge click">event</span>' +
              '<span class="ev-desc">Interaction #' + (i + 1) + '</span>' +
              '<span class="ev-time">' + self.formatTime(Date.now()) + '</span>';
            stream.appendChild(item);
            stream.scrollTop = stream.scrollHeight;
          }
          self.lastEventCount = count;
        }
      })
      .catch(function(err) {
        if (err.name === 'AbortError') return; // expected on stop
        self._pollFailCount++;
        if (self._pollFailCount >= 5) {
          self.stopPolling();
          alert('Lost connection to recording session.');
        }
      });
  },

  pollScreenshot: function() {
    if (!this.sessionId || !this._pollAbort) return;
    var container = document.getElementById('recPreviewBody');
    var signal = this._pollAbort.signal;
    fetch('/v1/sessions/' + this.sessionId + '/screenshot', { signal: signal })
      .then(function(r) { return r.ok ? r.json() : null; })
      .then(function(data) {
        if (data && data.image) {
          var imgEl = document.createElement('img');
          imgEl.src = data.image;
          imgEl.alt = 'Live preview';
          container.innerHTML = '';
          container.appendChild(imgEl);
        }
      })
      .catch(function() {}); // AbortError or network error — silent
  },

  renderReview: function(data) {
    var recording = data.recording || {};
    var events = recording.events || [];
    var domain = data.domain || recording.domain || '-';
    var duration = recording.endedAt && recording.startedAt
      ? Math.round((recording.endedAt - recording.startedAt) / 1000)
      : 0;
    var dMin = String(Math.floor(duration / 60)).padStart(2, '0');
    var dSec = String(duration % 60).padStart(2, '0');

    // Summary
    document.getElementById('recSummary').innerHTML =
      '<div class="sum-item"><strong>' + esc(domain) + '</strong><br>Domain</div>' +
      '<div class="sum-item"><strong>' + events.length + '</strong><br>Events</div>' +
      '<div class="sum-item"><strong>' + dMin + ':' + dSec + '</strong><br>Duration</div>';

    // Intent textarea — reset to loading state (summarizeIntent will fill it)
    var textarea = document.getElementById('recIntentText');
    textarea.value = '';
    textarea.classList.add('loading');
    textarea.disabled = true;
    document.getElementById('recIntentHint').textContent = 'AI summarizing...';

    // Timeline
    var timeline = document.getElementById('recTimeline');
    if (events.length === 0) {
      timeline.innerHTML = '<div class="rec-empty-events"><span>No events recorded.</span></div>';
    } else {
      var html = '';
      var self = this;
      events.forEach(function(evt) {
        html += self.renderEventItem(evt);
      });
      timeline.innerHTML = html;
    }

    // Patterns preview (show what will be extracted, not yet saved)
    var patternsBody = document.getElementById('recPatternsBody');
    var previewPatterns = extractPatternsFromEvents(events);

    if (previewPatterns.length > 0) {
      var phtml = '';
      previewPatterns.forEach(function(p) { phtml += Rec.renderPattern(p); });
      patternsBody.innerHTML = phtml;
    } else {
      patternsBody.innerHTML = '<div class="placeholder-text">No structural patterns detected.</div>';
    }

    // Reset action buttons and success area
    document.getElementById('recSuccessArea').innerHTML = '';
    document.getElementById('recActions').innerHTML =
      '<button class="btn" onclick="Rec.discard()">Discard</button>' +
      '<button class="btn btn-primary" id="recSaveBtn" onclick="Rec.saveToMemory()">Save to Memory</button>';
  },

  renderEventItem: function(evt) {
    var icons = { navigate: '&#8599;', click: '&#9673;', type: '&#9000;', select: '&#9776;', scroll: '&#8597;' };
    var icon = icons[evt.type] || '&#9679;';
    var desc = '';
    if (evt.type === 'navigate') {
      desc = evt.url || '';
    } else if (evt.type === 'click') {
      desc = evt.targetLabel || evt.target || 'element';
    } else if (evt.type === 'type') {
      desc = (evt.targetLabel || 'input') + (evt.value ? ': ' + evt.value.slice(0, 30) : '');
    } else if (evt.type === 'select') {
      desc = (evt.targetLabel || 'select') + (evt.value ? ' → ' + evt.value : '');
    } else if (evt.type === 'scroll') {
      desc = 'scrollY: ' + (evt.value || '0');
    }
    return '<div class="rec-event-item">' +
      '<span class="ev-icon">' + icon + '</span>' +
      '<span class="ev-badge ' + esc(evt.type) + '">' + esc(evt.type) + '</span>' +
      '<span class="ev-desc" title="' + esc(desc) + '">' + esc(desc) + '</span>' +
      '<span class="ev-time">' + this.formatTime(evt.timestamp) + '</span>' +
      '</div>';
  },

  renderPattern: function(p) {
    return '<div class="rec-pattern-item">' +
      '<span class="pat-type">' + esc(p.type) + '</span>' +
      '<div class="pat-desc">' + esc(p.description) + '</div>' +
      '<div class="pat-value">' + esc(p.value) + '</div>' +
      '</div>';
  },

  formatTime: function(ts) {
    if (!ts) return '';
    var d = new Date(ts);
    return String(d.getHours()).padStart(2, '0') + ':' +
      String(d.getMinutes()).padStart(2, '0') + ':' +
      String(d.getSeconds()).padStart(2, '0');
  }
};
</script>

<script>
// ========== Welcome Banner ==========
function dismissWelcome() {
  document.getElementById('welcomeBanner').style.display = 'none';
  localStorage.setItem('ai_browser_welcomed', '1');
}
function showWelcomeIfNeeded() {
  if (!localStorage.getItem('ai_browser_welcomed')) {
    document.getElementById('welcomeBanner').style.display = '';
  }
}
</script>

<script>
// ========== Init ==========
(function() {
  var hash = location.hash.replace('#', '');
  var view = (hash === 'agent') ? 'agent' : (hash === 'tasks') ? 'tasks' : (hash === 'memory') ? 'memory' : (hash === 'record') ? 'record' : 'semantic';
  switchView(view);
  ChatStore.load();
  showWelcomeIfNeeded();
})();
</script>
</body>
</html>
